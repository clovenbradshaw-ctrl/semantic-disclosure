<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Record Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }

    /* Settings modal transitions */
    #settings-modal [data-field-key] {
      transition: background-color 0.15s ease, transform 0.15s ease;
    }
    #settings-modal [data-field-key]:hover {
      background-color: rgba(243, 244, 246, 0.8);
    }
    #settings-modal .group:hover .opacity-50 {
      opacity: 1;
    }

    /* Mobile-friendly touch improvements */
    .touch-manipulation {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    /* Improve tap targets on mobile */
    @media (max-width: 640px) {
      button, a, input[type="checkbox"], input[type="number"], select {
        min-height: 44px;
      }

      /* Better text sizing on small screens */
      .text-xs {
        font-size: 0.8125rem;
        line-height: 1.25rem;
      }

      /* Prevent horizontal overflow */
      pre {
        max-width: 100%;
        overflow-x: auto;
        word-wrap: break-word;
      }

      /* Better scrolling on iOS */
      .overflow-y-auto, .overflow-x-auto {
        -webkit-overflow-scrolling: touch;
      }
    }

    /* Ensure proper word breaking for long text */
    .break-words {
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
    }

    /* Safe area insets for notched devices */
    @supports (padding: max(0px)) {
      #app {
        padding-left: max(1rem, env(safe-area-inset-left));
        padding-right: max(1rem, env(safe-area-inset-right));
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
      }
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <div id="app" class="p-3 sm:p-4 md:p-6">
    <div class="max-w-6xl mx-auto">
      <div class="text-center py-12">
        <div class="w-8 h-8 border-2 border-blue-400 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
        <p class="text-gray-500 text-sm">Loading client data...</p>
      </div>
    </div>
  </div>

  <script>
    const DATA_URL = 'https://n8n.intelechia.com/webhook/c68fda2a-9302-4efb-930b-7063b85ef595';
    const SCHEMA_URL = 'https://n8n.intelechia.com/webhook/843d64c9-d353-41cf-911f-2f184e211296';
    const SOFTR_BASE_URL = 'https://rklacylaw.softr.app/client-info';
    const STORAGE_KEY = 'semantic-disclosure-field-prefs-v3';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EXTERNAL LINK HELPERS - Generate URLs for Softr and Google Calendar
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function getSoftrClientUrl(recordId, tabHash = '') {
      const base = `${SOFTR_BASE_URL}?recordId=${encodeURIComponent(recordId)}`;
      return tabHash ? `${base}#${tabHash}` : base;
    }

    function getGoogleCalendarEventUrl(event) {
      // If the event has an htmlLink (direct Google Calendar link), use it
      if (event.htmlLink) return event.htmlLink;
      // Otherwise, construct a search URL to find the event
      const title = event.title || event.summary || 'Event';
      return `https://calendar.google.com/calendar/u/0/r/search?q=${encodeURIComponent(title)}`;
    }

    function renderExternalLinkIcon(url, title = 'Open in Softr') {
      return `
        <a href="${escapeHtml(url)}" target="_blank" title="${escapeHtml(title)}"
           class="p-2.5 sm:p-2 text-gray-500 hover:text-blue-600 hover:bg-gray-100 rounded-lg transition-colors touch-manipulation"
           onclick="event.stopPropagation()">
          <svg class="w-5 h-5 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
          </svg>
        </a>
      `;
    }

    function renderCalendarLinkIcon(url, title = 'Open in Google Calendar') {
      return `
        <a href="${escapeHtml(url)}" target="_blank" title="${escapeHtml(title)}"
           class="inline-flex items-center gap-1.5 px-3 py-2 sm:px-2 sm:py-1 text-sm sm:text-xs text-gray-500 hover:text-amber-600 hover:bg-gray-100 rounded transition-colors touch-manipulation"
           onclick="event.stopPropagation()">
          <svg class="w-4 h-4 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          <span>Calendar</span>
        </a>
      `;
    }

    // View mode: 'structured', 'brief', 'detailed', or 'timeline'
    let currentView = 'structured';

    // Notes sort order: 'asc' (oldest to newest) or 'desc' (newest to oldest)
    let notesSortOrder = 'asc';

    // Available views
    const VIEWS = ['structured', 'brief', 'detailed', 'timeline'];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIELD REGISTRY - Dynamically populated from schema, with fallback defaults
    // Each field defines which views it's relevant to and default visibility per view
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Default field registry (used as fallback if schema fetch fails)
    const DEFAULT_FIELD_REGISTRY = {
      client: [
        { key: 'name', label: 'Name', views: { structured: true, brief: true, detailed: true, timeline: false } },
        { key: 'aNumber', label: 'Alien Number (A#)', views: { structured: true, brief: true, detailed: true, timeline: false } },
        { key: 'dob', label: 'Date of Birth / Age', views: { structured: true, brief: true, detailed: true, timeline: true } },
        { key: 'country', label: 'Country', views: { structured: true, brief: true, detailed: true, timeline: false } },
        { key: 'phone', label: 'Phone Number', views: { structured: true, brief: false, detailed: true, timeline: false } },
        { key: 'address', label: 'Address', views: { structured: true, brief: false, detailed: true, timeline: false } },
        { key: 'sijStatus', label: 'SIJ Status', views: { structured: true, brief: true, detailed: true, timeline: false } },
        { key: 'tags', label: 'Tags', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'flatpack', label: 'Matter Details (Flatpack)', views: { structured: false, brief: false, detailed: false, timeline: false } },
      ],
      cases: [
        { key: 'type', label: 'Case Type', views: { structured: true, brief: true, detailed: true, timeline: true } },
        { key: 'court', label: 'Court/Office', views: { structured: true, brief: true, detailed: true, timeline: true } },
        { key: 'judge', label: 'Judge', views: { structured: true, brief: false, detailed: true, timeline: true } },
        { key: 'hearingDate', label: 'Hearing Date', views: { structured: true, brief: true, detailed: true, timeline: true } },
        { key: 'daysToHearing', label: 'Days to Hearing', views: { structured: true, brief: true, detailed: true, timeline: false } },
        { key: 'oyd', label: 'One-Year Deadline (OYD)', views: { structured: false, brief: false, detailed: true, timeline: true } },
        { key: 'notes', label: 'Case Notes', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'flatpack', label: 'Case Flatpack Data', views: { structured: false, brief: false, detailed: false, timeline: false } },
      ],
      applications: [
        { key: 'type', label: 'Application Type', views: { structured: true, brief: true, detailed: true, timeline: true } },
        { key: 'name', label: 'Name/Matter', views: { structured: true, brief: false, detailed: true, timeline: false } },
        { key: 'status', label: 'Status', views: { structured: true, brief: true, detailed: true, timeline: true } },
        { key: 'receiptNumber', label: 'Receipt Number', views: { structured: true, brief: false, detailed: true, timeline: false } },
        { key: 'filedDate', label: 'Filed Date', views: { structured: false, brief: false, detailed: true, timeline: true } },
        { key: 'certCounty', label: 'County/State', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'notes', label: 'Notes', views: { structured: false, brief: false, detailed: true, timeline: false } },
      ],
      events: [
        { key: 'title', label: 'Title', views: { structured: true, brief: true, detailed: true, timeline: true } },
        { key: 'dateTime', label: 'Date/Time', views: { structured: true, brief: true, detailed: true, timeline: true } },
        { key: 'location', label: 'Location', views: { structured: true, brief: false, detailed: true, timeline: true } },
        { key: 'calendarType', label: 'Calendar Type', views: { structured: true, brief: false, detailed: true, timeline: false } },
        { key: 'meetLink', label: 'Video Link', views: { structured: true, brief: false, detailed: true, timeline: true } },
        { key: 'description', label: 'Description', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'attendees', label: 'Attendees', views: { structured: false, brief: false, detailed: true, timeline: false } },
      ],
      notes: [
        { key: 'id', label: 'ID', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'activity', label: 'Activity', views: { structured: true, brief: true, detailed: true, timeline: false } },
        { key: 'type', label: 'Type', views: { structured: true, brief: true, detailed: true, timeline: false } },
        { key: 'date', label: 'Date', views: { structured: true, brief: true, detailed: true, timeline: true } },
        { key: 'description', label: 'Description', views: { structured: true, brief: false, detailed: true, timeline: false } },
        { key: 'contact', label: 'Contact', views: { structured: true, brief: false, detailed: true, timeline: false } },
        { key: 'clientPpId', label: 'Client PP ID', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'matter', label: 'Matter', views: { structured: true, brief: false, detailed: true, timeline: false } },
        { key: 'recordId', label: 'Record ID', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'createdBy', label: 'Created By', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'softrLink', label: 'Softr Link', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'updated', label: 'Updated', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'modified', label: 'Modified', views: { structured: false, brief: false, detailed: true, timeline: true } },
        { key: 'dueDate', label: 'Due Date', views: { structured: true, brief: false, detailed: true, timeline: true } },
        { key: 'lastUpdateBy', label: 'Last Update By', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'unixTimestamp', label: 'Unix Timestamp', views: { structured: false, brief: false, detailed: false, timeline: false } },
        { key: 'timeRaw', label: 'Time Raw', views: { structured: false, brief: false, detailed: false, timeline: false } },
        { key: 'tags', label: 'Tags', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'ppNoteId', label: 'PP Note ID', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'matterId', label: 'Matter ID', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'source', label: 'Source', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'clientAirtableId', label: 'Client Airtable ID', views: { structured: false, brief: false, detailed: true, timeline: false } },
        { key: 'eventId', label: 'Event ID', views: { structured: false, brief: false, detailed: true, timeline: false } },
      ]
    };

    // Dynamic field registry - will be populated from schema
    let FIELD_REGISTRY = JSON.parse(JSON.stringify(DEFAULT_FIELD_REGISTRY));

    // Map table names from schema to our category names
    const TABLE_TO_CATEGORY = {
      'clients': 'client',
      'client': 'client',
      'client info': 'client',
      'clientinfo': 'client',
      'cases': 'cases',
      'case': 'cases',
      'case master view': 'cases',
      'casemasterview': 'cases',
      'matter': 'cases',
      'applications': 'applications',
      'application': 'applications',
      'events': 'events',
      'event': 'events',
      'calendar': 'events',
      'hearings': 'events',
      'hearing': 'events',
      'deadlines': 'events',
      'deadlines 2.0': 'events',
      'case & event notes': 'notes',
      'case and event notes': 'notes',
      'caseeventnotes': 'notes',
      'notes': 'notes',
      'case notes': 'notes',
      'event notes': 'notes'
    };

    // Helper to find category from table name (uses partial matching as fallback)
    function getCategoryFromTableName(tableName) {
      const normalized = tableName.toLowerCase().trim();
      // Exact match first
      if (TABLE_TO_CATEGORY[normalized]) {
        return TABLE_TO_CATEGORY[normalized];
      }
      // Partial matching fallback
      if (normalized.includes('client')) return 'client';
      // Check for notes before cases since "case notes" should go to notes, not cases
      if (normalized.includes('note') && (normalized.includes('case') || normalized.includes('event'))) return 'notes';
      if (normalized.includes('case') || normalized.includes('matter')) return 'cases';
      if (normalized.includes('application')) return 'applications';
      if (normalized.includes('event') || normalized.includes('hearing') || normalized.includes('calendar') || normalized.includes('deadline')) return 'events';
      return null;
    }

    // Fields to exclude from the field list (internal/system fields)
    const EXCLUDED_FIELDS = new Set([
      'id', 'recordId', 'createdTime', 'createdBy', 'modifiedTime', 'modifiedBy',
      '_rawJson', '_table', 'fields'
    ]);

    // Date fields by category - only these fields can appear in timeline view
    const DATE_FIELDS = {
      client: new Set(['dob', 'entryDate', 'createdTime']),
      cases: new Set(['hearingDate', 'oyd', 'createdTime', 'filingDate']),
      applications: new Set(['filedDate', 'createdTime', 'decisionDate', 'expirationDate']),
      events: new Set(['dateTime', 'startDateTime', 'endDateTime', 'createdTime']),
      notes: new Set(['date', 'dueDate', 'createdTime', 'Modified', 'Updated'])
    };

    // Helper to check if a field is a date field
    function isDateField(category, key) {
      // Check explicit date fields set
      if (DATE_FIELDS[category]?.has(key)) return true;
      // Also check by naming convention (contains date, time, deadline, etc.)
      const lowerKey = key.toLowerCase();
      return lowerKey.includes('date') || lowerKey.includes('time') ||
             lowerKey.includes('deadline') || lowerKey.includes('dob') ||
             lowerKey.includes('oyd') || lowerKey.includes('entry');
    }

    // Fields that are already handled specially in rendering (mapped to our internal keys)
    const SPECIAL_FIELD_MAPPINGS = {
      client: {
        'Full Name': 'name',
        'First Name': 'name',
        'Last Name': 'name',
        'A#': 'aNumber',
        'A Number': 'aNumber',
        'Alien Number': 'aNumber',
        'DOB': 'dob',
        'Date of Birth': 'dob',
        'Country': 'country',
        'Country of Origin': 'country',
        'Phone': 'phone',
        'Phone Number': 'phone',
        'Address': 'address',
        'Address Line 1': 'address',
        'SIJ Status': 'sijStatus',
        'Tags': 'tags',
        'Matter_Flatpack': 'flatpack',
        'Matter_Flatpack (from Case Master View // Activities)': 'flatpack',
        'bahr_import_flatpack_data': 'flatpack'
      },
      cases: {
        'Case Type': 'type',
        'Type': 'type',
        'Court': 'court',
        'Court/Office': 'court',
        'Office': 'court',
        'Judge': 'judge',
        'Hearing Date': 'hearingDate',
        'Next Hearing': 'hearingDate',
        'Days to Hearing': 'daysToHearing',
        'OYD': 'oyd',
        'One-Year Deadline': 'oyd',
        'Notes': 'notes',
        'Case Notes': 'notes',
        'Matter_Flatpack': 'flatpack'
      },
      applications: {
        'Application': 'type',
        'Application Type': 'type',
        'Type': 'type',
        'Name': 'name',
        'Matter': 'name',
        'Status': 'status',
        'Receipt Number': 'receiptNumber',
        'Receipt #': 'receiptNumber',
        'Receipt Date': 'filedDate',
        'Filed Date': 'filedDate',
        'Date Filed': 'filedDate',
        'Cert County/State': 'certCounty',
        'County': 'certCounty',
        'State': 'certCounty',
        'Notes': 'notes'
      },
      events: {
        'Title': 'title',
        'Summary': 'title',
        'Event Title': 'title',
        'Date': 'dateTime',
        'Time': 'dateTime',
        'Start': 'dateTime',
        'Start Time': 'dateTime',
        'Location': 'location',
        'Where': 'location',
        'Calendar': 'calendarType',
        'Calendar Type': 'calendarType',
        'Meet Link': 'meetLink',
        'Video Link': 'meetLink',
        'Hangout Link': 'meetLink',
        'Description': 'description',
        'Details': 'description',
        'Attendees': 'attendees',
        'Guests': 'attendees'
      },
      notes: {
        'id': 'id',
        'Activity': 'activity',
        'Type': 'type',
        'Date': 'date',
        'Description': 'description',
        'Contact': 'contact',
        'Client_PP_ID': 'clientPpId',
        'Matter': 'matter',
        'matter': 'matter',
        'RecordId': 'recordId',
        'Created_By': 'createdBy',
        'Created By': 'createdBy',
        'Softr_Link_to_clients': 'softrLink',
        'Updated': 'updated',
        'Modified': 'modified',
        'Due_Date': 'dueDate',
        'Due Date': 'dueDate',
        'Last_Update_By': 'lastUpdateBy',
        'unix_timestamp': 'unixTimestamp',
        'time_raw': 'timeRaw',
        'tags': 'tags',
        'Tags': 'tags',
        'pp_note_id': 'ppNoteId',
        'matter_id': 'matterId',
        'source': 'source',
        'Source': 'source',
        'client_airtable_id': 'clientAirtableId',
        'eventId': 'eventId'
      }
    };

    // Fetch schema and build dynamic field registry
    async function fetchSchemaAndBuildRegistry() {
      try {
        const response = await fetch(SCHEMA_URL);
        if (!response.ok) throw new Error(`Schema fetch failed: ${response.status}`);
        const schema = await response.json();

        console.log('Schema loaded:', schema);

        // Build registry from schema
        const newRegistry = { client: [], cases: [], applications: [], events: [], notes: [] };

        // Track which internal keys we've already added per category
        const addedKeys = {
          client: new Set(),
          cases: new Set(),
          applications: new Set(),
          events: new Set(),
          notes: new Set()
        };

        // First, add all the default fields to preserve ordering and special handling
        for (const [category, fields] of Object.entries(DEFAULT_FIELD_REGISTRY)) {
          for (const field of fields) {
            newRegistry[category].push({ ...field });
            addedKeys[category].add(field.key);
          }
        }

        // Process schema - handle both array of tables and single table object
        const tables = Array.isArray(schema) ? schema : (schema.tables || [schema]);

        for (const table of tables) {
          const tableName = (table.name || table.tableName || '');
          const category = getCategoryFromTableName(tableName);

          if (!category) {
            console.log(`Skipping unknown table: ${tableName}`);
            continue;
          }

          // Get fields from table - support various schema formats
          const fields = table.fields || table.columns || [];

          for (const field of fields) {
            const fieldName = field.name || field.fieldName || field;
            if (typeof fieldName !== 'string') continue;

            // Skip excluded fields
            if (EXCLUDED_FIELDS.has(fieldName)) continue;

            // Check if this field maps to a special internal key
            const specialKey = SPECIAL_FIELD_MAPPINGS[category]?.[fieldName];
            if (specialKey && addedKeys[category].has(specialKey)) {
              continue; // Already have this field with special handling
            }

            // Create a key from the field name (camelCase)
            const key = specialKey || fieldName
              .replace(/[^a-zA-Z0-9\s]/g, '')
              .replace(/\s+(.)/g, (_, c) => c.toUpperCase())
              .replace(/^\w/, c => c.toLowerCase());

            // Skip if we already have this key
            if (addedKeys[category].has(key)) continue;

            // Add new field - hidden by default so users can opt-in to any field they want
            newRegistry[category].push({
              key: key,
              label: fieldName,
              views: { structured: false, brief: false, detailed: false, timeline: false },
              // Store original field name for data access
              sourceField: fieldName,
              // Mark as schema-derived field (not a core field)
              fromSchema: true
            });
            addedKeys[category].add(key);
          }
        }

        // Update the global registry
        FIELD_REGISTRY = newRegistry;
        console.log('Dynamic field registry built:', FIELD_REGISTRY);

        return true;
      } catch (err) {
        console.warn('Failed to fetch schema, using default registry:', err);
        return false;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIELD PREFERENCES - Per-view localStorage persistence with ordering
    // Structure: { view: { category: [{ key, visible }, ...] } }
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildDefaultPrefs() {
      const prefs = {};
      VIEWS.forEach(view => {
        prefs[view] = {};
        for (const [category, fields] of Object.entries(FIELD_REGISTRY)) {
          prefs[view][category] = fields.map(f => ({
            key: f.key,
            visible: f.views[view] ?? false
          }));
        }
      });
      return prefs;
    }

    function loadFieldPrefs() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          // Merge with defaults to handle new fields and views
          const defaults = buildDefaultPrefs();
          for (const view of VIEWS) {
            if (!parsed[view]) parsed[view] = {};
            for (const [category, fields] of Object.entries(FIELD_REGISTRY)) {
              if (!parsed[view][category] || !Array.isArray(parsed[view][category])) {
                parsed[view][category] = defaults[view][category];
              } else {
                // Ensure all fields from registry exist in prefs
                const existingKeys = new Set(parsed[view][category].map(f => f.key));
                fields.forEach(f => {
                  if (!existingKeys.has(f.key)) {
                    parsed[view][category].push({
                      key: f.key,
                      visible: f.views[view] ?? false
                    });
                  }
                });
                // Remove fields that no longer exist in registry
                const registryKeys = new Set(fields.map(f => f.key));
                parsed[view][category] = parsed[view][category].filter(f => registryKeys.has(f.key));
              }
            }
          }
          return parsed;
        }
      } catch (e) {
        console.warn('Failed to load field preferences:', e);
      }
      return buildDefaultPrefs();
    }

    function saveFieldPrefs(prefs) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));
      } catch (e) {
        console.warn('Failed to save field preferences:', e);
      }
    }

    // Get visible fields for a category in the current view, in order
    function getVisibleFields(category, view = currentView) {
      const prefs = loadFieldPrefs();
      const viewPrefs = prefs[view]?.[category] || [];
      return viewPrefs.filter(f => f.visible).map(f => f.key);
    }

    // Get all fields for a category in the current view, in order (with visibility info)
    function getFieldsInOrder(category, view = currentView) {
      const prefs = loadFieldPrefs();
      const viewPrefs = prefs[view]?.[category] || [];
      const registry = FIELD_REGISTRY[category] || [];

      return viewPrefs.map(f => {
        const regField = registry.find(r => r.key === f.key);
        return {
          key: f.key,
          label: regField?.label || f.key,
          visible: f.visible,
          sourceField: regField?.sourceField
        };
      });
    }

    function isFieldVisible(category, key, view = currentView) {
      const prefs = loadFieldPrefs();
      const viewPrefs = prefs[view]?.[category] || [];
      const field = viewPrefs.find(f => f.key === key);
      return field?.visible ?? false;
    }

    function setFieldVisibility(category, key, visible, view = currentView) {
      const prefs = loadFieldPrefs();
      if (!prefs[view]) prefs[view] = {};
      if (!prefs[view][category]) prefs[view][category] = [];

      const fieldIdx = prefs[view][category].findIndex(f => f.key === key);
      if (fieldIdx >= 0) {
        prefs[view][category][fieldIdx].visible = visible;
      } else {
        prefs[view][category].push({ key, visible });
      }
      saveFieldPrefs(prefs);
    }

    function moveField(category, key, direction, view = currentView) {
      const prefs = loadFieldPrefs();
      if (!prefs[view]?.[category]) return;

      const fields = prefs[view][category];
      const idx = fields.findIndex(f => f.key === key);
      if (idx < 0) return;

      const newIdx = direction === 'up' ? idx - 1 : idx + 1;
      if (newIdx < 0 || newIdx >= fields.length) return;

      // Swap fields
      [fields[idx], fields[newIdx]] = [fields[newIdx], fields[idx]];
      saveFieldPrefs(prefs);
    }

    function moveFieldToPosition(category, key, targetPosition, view = currentView) {
      const prefs = loadFieldPrefs();
      if (!prefs[view]?.[category]) return;

      const fields = prefs[view][category];
      const currentIdx = fields.findIndex(f => f.key === key);
      if (currentIdx < 0) return;

      // Convert 1-indexed position to 0-indexed
      const targetIdx = Math.max(0, Math.min(fields.length - 1, targetPosition - 1));
      if (targetIdx === currentIdx) return;

      // Remove from current position and insert at target
      const [field] = fields.splice(currentIdx, 1);
      fields.splice(targetIdx, 0, field);
      saveFieldPrefs(prefs);
    }

    function resetFieldPrefs() {
      const defaults = buildDefaultPrefs();
      saveFieldPrefs(defaults);
      return defaults;
    }

    function resetViewPrefs(view) {
      const prefs = loadFieldPrefs();
      const defaults = buildDefaultPrefs();
      prefs[view] = defaults[view];
      saveFieldPrefs(prefs);
      return prefs;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SETTINGS MODAL - Per-view field configuration with reordering
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let settingsCurrentView = 'structured';

    function openSettingsModal() {
      settingsCurrentView = currentView;
      document.body.style.overflow = 'hidden';
      renderSettingsModal();
    }

    function renderSettingsModal() {
      // Remove existing modal if present
      const existingModal = document.getElementById('settings-modal');
      if (existingModal) existingModal.remove();

      // Category labels with context about single vs multiple records
      const categoryLabels = {
        client: {
          label: 'Client Fields',
          sublabel: 'Single record per client',
          icon: 'ğŸ‘¤'
        },
        cases: {
          label: 'Case Fields',
          sublabel: 'Card elements (multiple records)',
          icon: 'âš–ï¸'
        },
        applications: {
          label: 'Application Fields',
          sublabel: 'Card elements (multiple records)',
          icon: 'ğŸ“'
        },
        events: {
          label: 'Event & Hearing Fields',
          sublabel: 'Card elements (multiple records)',
          icon: 'ğŸ“…'
        },
        notes: {
          label: 'Notes Fields',
          sublabel: 'Case & event notes (multiple records)',
          icon: 'ğŸ“‹'
        }
      };

      // Timeline-specific sublabels
      const timelineSublabels = {
        client: 'Date fields from client record',
        cases: 'Date fields from case records',
        applications: 'Date fields from applications',
        events: 'Date fields from events/hearings',
        notes: 'Date fields from notes'
      };

      const viewLabels = {
        structured: 'Structured',
        brief: 'Brief',
        detailed: 'Detailed',
        timeline: 'Timeline'
      };

      // View tabs
      const viewTabsHtml = VIEWS.map(view => {
        const active = settingsCurrentView === view;
        return `
          <button onclick="switchSettingsView('${view}')"
                  class="px-4 py-3 sm:px-3 sm:py-2 text-sm font-medium rounded-t-lg transition-colors touch-manipulation ${active
                    ? 'bg-gray-100 text-gray-900 border-b-2 border-blue-500'
                    : 'text-gray-500 hover:text-gray-800 hover:bg-gray-100/50'}">
            ${viewLabels[view]}
          </button>
        `;
      }).join('');

      // Build categories for the selected view
      const isTimelineView = settingsCurrentView === 'timeline';

      const categoriesHtml = Object.entries(FIELD_REGISTRY).map(([category, registryFields]) => {
        let fields = getFieldsInOrder(category, settingsCurrentView);

        // For timeline view, only show date fields
        if (isTimelineView) {
          fields = fields.filter(f => isDateField(category, f.key));
        }

        // Skip category if no fields to show
        if (fields.length === 0) {
          return '';
        }

        const fieldsHtml = fields.map((f, idx) => {
          const isFirst = idx === 0;
          const isLast = idx === fields.length - 1;

          const position = idx + 1; // 1-indexed for display
          return `
            <div class="flex items-center gap-3 sm:gap-2 py-3 sm:py-2 px-3 sm:px-2 rounded hover:bg-gray-100/50 group" data-field-key="${f.key}">
              <input type="number"
                     value="${position}"
                     min="1"
                     max="${fields.length}"
                     onchange="handlePositionChange('${category}', '${f.key}', this.value, event)"
                     class="w-12 sm:w-10 h-10 sm:h-7 text-sm sm:text-xs text-center bg-gray-100 border border-gray-300 rounded text-gray-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                     title="Type a position number to move this field">
              <div class="flex flex-col gap-1 sm:gap-0.5 opacity-70 sm:opacity-50 group-hover:opacity-100">
                <button onclick="handleMoveField('${category}', '${f.key}', 'up', event)"
                        class="p-2 sm:p-1 hover:bg-gray-200 rounded touch-manipulation ${isFirst ? 'invisible' : ''}"
                        title="Move up">
                  <svg class="w-4 h-4 sm:w-3 sm:h-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                </button>
                <button onclick="handleMoveField('${category}', '${f.key}', 'down', event)"
                        class="p-2 sm:p-1 hover:bg-gray-200 rounded touch-manipulation ${isLast ? 'invisible' : ''}"
                        title="Move down">
                  <svg class="w-4 h-4 sm:w-3 sm:h-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </button>
              </div>
              <label class="flex items-center gap-3 sm:gap-2 flex-1 cursor-pointer min-w-0">
                <input type="checkbox" ${f.visible ? 'checked' : ''}
                       data-category="${category}"
                       data-key="${f.key}"
                       data-view="${settingsCurrentView}"
                       class="w-5 h-5 sm:w-4 sm:h-4 rounded border-gray-300 bg-gray-100 text-blue-500 focus:ring-blue-500 focus:ring-offset-white flex-shrink-0">
                <div class="flex flex-col min-w-0">
                  <span class="text-base sm:text-sm text-gray-700 truncate">${f.label}</span>
                  <span class="text-sm sm:text-xs text-gray-400 truncate">
                    <span class="font-mono text-gray-500">${f.sourceField || f.label}</span>
                  </span>
                </div>
              </label>
            </div>
          `;
        }).join('');

        const catInfo = categoryLabels[category];
        const sublabel = isTimelineView ? timelineSublabels[category] : catInfo.sublabel;

        return `
          <div class="mb-5" id="settings-cat-${category}">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-lg">${catInfo.icon}</span>
              <div>
                <h3 class="text-sm font-semibold text-gray-700">${catInfo.label}</h3>
                <p class="text-xs text-gray-400">${sublabel}</p>
              </div>
            </div>
            <div class="space-y-0.5 bg-white/50 rounded-lg p-1" id="fields-${category}">
              ${fieldsHtml}
            </div>
          </div>
        `;
      }).join('');

      // Build category jump links
      const categoryJumpLinks = Object.entries(categoryLabels).map(([cat, info]) => {
        // For timeline, only show categories with date fields
        if (isTimelineView) {
          const dateFields = getFieldsInOrder(cat, settingsCurrentView).filter(f => isDateField(cat, f.key));
          if (dateFields.length === 0) return '';
        }
        return `<button onclick="document.getElementById('settings-cat-${cat}').scrollIntoView({behavior:'smooth'})"
                        class="flex items-center gap-1.5 px-3 py-2 sm:px-2 sm:py-1 rounded text-sm sm:text-xs bg-gray-100/50 hover:bg-gray-100 text-gray-700 transition-colors touch-manipulation">
                  <span>${info.icon}</span>
                  <span>${info.label.replace(' Fields', '')}</span>
                </button>`;
      }).filter(Boolean).join('');

      const modalHtml = `
        <div id="settings-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-2 sm:p-4" onclick="if(event.target.id === 'settings-modal') closeSettingsModal()">
          <div class="bg-white rounded-xl border border-gray-200 shadow-xl w-full sm:max-w-xl lg:max-w-3xl max-h-[90vh] sm:max-h-[85vh] overflow-hidden flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-gray-200 flex-shrink-0">
              <div>
                <h2 class="text-lg font-semibold text-gray-900">Field Settings</h2>
                <p class="text-gray-400 text-sm sm:text-xs mt-0.5">Customize fields for each view</p>
              </div>
              <button onclick="closeSettingsModal()" class="text-gray-500 hover:text-gray-800 p-2.5 sm:p-1.5 -mr-1 touch-manipulation">
                <svg class="w-6 h-6 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>

            <div class="border-b border-gray-200 bg-white/80 flex-shrink-0 overflow-x-auto">
              <div class="flex gap-1 px-4 pt-2 min-w-max">${viewTabsHtml}</div>
            </div>

            <div class="px-4 pt-3 pb-2 border-b border-gray-200/50 bg-white flex-shrink-0">
              <p class="text-gray-500 text-sm mb-2">
                Configure which fields appear in the <span class="text-blue-600 font-medium">${viewLabels[settingsCurrentView]}</span> view${isTimelineView ? ' (date fields only)' : ''}.
              </p>
              <div class="flex flex-wrap gap-2 sm:gap-1.5">
                ${categoryJumpLinks}
              </div>
            </div>

            <div class="p-4 overflow-y-auto flex-1 min-h-0">
              ${categoriesHtml}
            </div>

            <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 sm:gap-2 p-4 border-t border-gray-200 bg-white/50 flex-shrink-0">
              <div class="flex gap-2 order-2 sm:order-1">
                <button onclick="resetViewAndRefresh()" class="flex-1 sm:flex-none text-sm text-gray-500 hover:text-gray-800 px-4 py-2.5 sm:px-3 sm:py-1.5 rounded hover:bg-gray-100 transition-colors touch-manipulation">
                  Reset View
                </button>
                <button onclick="resetAllAndRefresh()" class="flex-1 sm:flex-none text-sm text-red-600/70 hover:text-red-600 px-4 py-2.5 sm:px-3 sm:py-1.5 rounded hover:bg-red-100 transition-colors touch-manipulation">
                  Reset All
                </button>
              </div>
              <button onclick="closeSettingsModal()" class="order-1 sm:order-2 text-sm bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 sm:py-2 rounded-lg sm:rounded transition-colors touch-manipulation font-medium">
                Done
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);
      attachSettingsListeners();
    }

    function attachSettingsListeners() {
      // Checkbox listeners
      document.querySelectorAll('#settings-modal input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const category = e.target.dataset.category;
          const key = e.target.dataset.key;
          const view = e.target.dataset.view;
          setFieldVisibility(category, key, e.target.checked, view);
          // Re-render the main view if we're editing the current view
          if (view === currentView && window.currentData) {
            renderData(window.currentData);
          }
        });
      });
    }

    function handleMoveField(category, key, direction, event) {
      event.preventDefault();
      event.stopPropagation();
      moveField(category, key, direction, settingsCurrentView);
      renderSettingsModal();
      // Re-render the main view if we're editing the current view
      if (settingsCurrentView === currentView && window.currentData) {
        renderData(window.currentData);
      }
    }

    function handlePositionChange(category, key, newPosition, event) {
      event.preventDefault();
      event.stopPropagation();
      const pos = parseInt(newPosition, 10);
      if (isNaN(pos) || pos < 1) return;
      moveFieldToPosition(category, key, pos, settingsCurrentView);
      renderSettingsModal();
      // Re-render the main view if we're editing the current view
      if (settingsCurrentView === currentView && window.currentData) {
        renderData(window.currentData);
      }
    }

    function switchSettingsView(view) {
      settingsCurrentView = view;
      renderSettingsModal();
    }

    function closeSettingsModal() {
      const modal = document.getElementById('settings-modal');
      if (modal) modal.remove();
      document.body.style.overflow = '';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GENERIC MODAL UTILITY - Handles callbacks safely
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Store for modal callbacks to ensure they're always accessible
    const modalCallbacks = {};

    function showModal({ id, title, content, onConfirm, onCancel, confirmText = 'Save', cancelText = 'Cancel' }) {
      // Remove existing modal with same id if present
      const existingModal = document.getElementById(id);
      if (existingModal) existingModal.remove();

      // Store callbacks with validation
      modalCallbacks[id] = {
        onConfirm: typeof onConfirm === 'function' ? onConfirm : null,
        onCancel: typeof onCancel === 'function' ? onCancel : null
      };

      const modalHtml = `
        <div id="${id}" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4" onclick="handleModalBackdropClick(event, '${id}')">
          <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between p-4 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-gray-900">${escapeHtml(title)}</h2>
              <button onclick="closeModal('${id}')" class="text-gray-400 hover:text-gray-600 p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            <div class="p-4">
              ${content}
            </div>
            <div class="flex justify-end gap-2 p-4 border-t border-gray-200 bg-gray-50/50 rounded-b-xl">
              <button onclick="handleModalCancel('${id}')" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
                ${escapeHtml(cancelText)}
              </button>
              <button onclick="handleModalConfirm('${id}')" class="px-4 py-2 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors font-medium">
                ${escapeHtml(confirmText)}
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);
      document.body.style.overflow = 'hidden';
    }

    function handleModalBackdropClick(event, modalId) {
      if (event.target.id === modalId) {
        closeModal(modalId);
      }
    }

    function handleModalConfirm(modalId) {
      const callbacks = modalCallbacks[modalId];
      if (callbacks && typeof callbacks.onConfirm === 'function') {
        callbacks.onConfirm();
      }
      closeModal(modalId);
    }

    function handleModalCancel(modalId) {
      const callbacks = modalCallbacks[modalId];
      if (callbacks && typeof callbacks.onCancel === 'function') {
        callbacks.onCancel();
      }
      closeModal(modalId);
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.remove();
      document.body.style.overflow = '';
      // Clean up stored callbacks
      delete modalCallbacks[modalId];
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DETAIL MODAL - Shows all details for an item (read-only)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function showDetailModal({ id, title, subtitle, badge, badgeClass, fields, externalUrl, externalLabel }) {
      // Remove existing modal with same id if present
      const existingModal = document.getElementById(id);
      if (existingModal) existingModal.remove();

      const badgeHtml = badge ? `<span class="px-2 py-1 rounded text-xs ${badgeClass || 'bg-gray-100 text-gray-600'}">${escapeHtml(badge)}</span>` : '';
      const subtitleHtml = subtitle ? `<p class="text-sm text-gray-500 mt-1">${escapeHtml(subtitle)}</p>` : '';

      const fieldsHtml = fields.map(field => {
        if (!field.value && field.value !== 0) return '';

        let valueHtml = '';
        if (field.type === 'link' && field.value) {
          valueHtml = `<a href="${escapeHtml(field.value)}" target="_blank" class="text-blue-600 hover:underline break-all">${escapeHtml(field.linkLabel || field.value)}</a>`;
        } else if (field.type === 'badge') {
          valueHtml = `<span class="px-2 py-1 rounded text-xs ${field.badgeClass || 'bg-gray-100 text-gray-600'}">${escapeHtml(String(field.value))}</span>`;
        } else if (field.type === 'date') {
          valueHtml = `<span class="text-gray-900">${formatDate(field.value)}</span>`;
        } else if (field.type === 'datetime') {
          const dateObj = new Date(field.value);
          const time = dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
          valueHtml = `<span class="text-gray-900">${formatDate(field.value)} at ${time}</span>`;
        } else if (field.type === 'list' && Array.isArray(field.value)) {
          valueHtml = field.value.map(v => `<span class="inline-block px-2 py-1 bg-gray-100 rounded text-xs mr-1 mb-1">${escapeHtml(String(v))}</span>`).join('');
        } else if (field.type === 'pre') {
          valueHtml = `<pre class="mt-1 p-2 bg-gray-50 rounded text-xs text-gray-700 whitespace-pre-wrap max-h-40 overflow-y-auto">${escapeHtml(String(field.value))}</pre>`;
        } else if (field.type === 'mono') {
          valueHtml = `<span class="font-mono text-blue-600">${escapeHtml(String(field.value))}</span>`;
        } else {
          valueHtml = `<span class="text-gray-900">${escapeHtml(String(field.value))}</span>`;
        }

        return `
          <div class="py-2 border-b border-gray-100 last:border-b-0">
            <div class="text-xs text-gray-500 mb-1">${escapeHtml(field.label)}</div>
            <div class="text-sm">${valueHtml}</div>
          </div>
        `;
      }).filter(Boolean).join('');

      const externalLinkHtml = externalUrl ? `
        <a href="${escapeHtml(externalUrl)}" target="_blank" class="inline-flex items-center gap-1 text-sm text-blue-600 hover:text-blue-700 hover:underline">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
          </svg>
          ${escapeHtml(externalLabel || 'Open in Softr')}
        </a>
      ` : '';

      const modalHtml = `
        <div id="${id}" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4" onclick="if(event.target.id === '${id}') closeModal('${id}')">
          <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="flex items-start justify-between p-4 border-b border-gray-200 flex-shrink-0">
              <div class="flex-1 min-w-0 pr-4">
                <div class="flex items-center gap-2 flex-wrap">
                  <h2 class="text-lg font-semibold text-gray-900">${escapeHtml(title)}</h2>
                  ${badgeHtml}
                </div>
                ${subtitleHtml}
              </div>
              <button onclick="closeModal('${id}')" class="text-gray-400 hover:text-gray-600 p-1 flex-shrink-0">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
              ${fieldsHtml || '<p class="text-gray-500 text-sm">No details available</p>'}
            </div>
            ${externalLinkHtml ? `
              <div class="flex justify-between items-center p-4 border-t border-gray-200 bg-gray-50/50 rounded-b-xl flex-shrink-0">
                ${externalLinkHtml}
                <button onclick="closeModal('${id}')" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
                  Close
                </button>
              </div>
            ` : `
              <div class="flex justify-end p-4 border-t border-gray-200 bg-gray-50/50 rounded-b-xl flex-shrink-0">
                <button onclick="closeModal('${id}')" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
                  Close
                </button>
              </div>
            `}
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);
      document.body.style.overflow = 'hidden';
    }

    function showApplicationDetailModal(app) {
      const statusColors = {
        'Engaged': 'bg-green-500/20 text-green-600',
        'Potential': 'bg-amber-500/20 text-amber-600',
        'Filed': 'bg-blue-500/20 text-blue-600',
        'Pending': 'bg-amber-500/20 text-amber-600',
        'Approved': 'bg-emerald-500/20 text-emerald-600',
        'Denied': 'bg-red-500/20 text-red-600'
      };

      const fields = [
        { label: 'Application Type', value: app.Application },
        { label: 'Status', value: app.Status, type: 'badge', badgeClass: statusColors[app.Status] || 'bg-gray-100 text-gray-600' },
        { label: 'Name/Matter', value: app.Name },
        { label: 'Receipt Number', value: app['Receipt Number'], type: 'mono' },
        { label: 'County/State', value: app['Cert County/State'] },
        { label: 'Created', value: app.createdTime, type: 'date' },
        { label: 'Notes', value: app.Notes, type: 'pre' }
      ];

      // Add any flatpack fields if present
      if (app._flatpack && typeof app._flatpack === 'object') {
        Object.entries(app._flatpack).forEach(([key, value]) => {
          if (value && !key.toLowerCase().includes('flatpack') && !/merge[_.\s-]*history/i.test(key)) {
            fields.push({ label: formatFlatpackKey(key), value: formatFlatpackValue(value) });
          }
        });
      }

      showDetailModal({
        id: 'app-detail-modal',
        title: app.Application || 'Application',
        subtitle: app.Name,
        badge: app.Status,
        badgeClass: statusColors[app.Status] || 'bg-gray-100 text-gray-600',
        fields: fields,
        externalUrl: getSoftrClientUrl(getRecordId(), 'tab15'),
        externalLabel: 'Open Applications in Softr'
      });
    }

    function showEventDetailModal(event) {
      const startDate = getEventStartDate(event);
      const endDate = getEventEndDate(event);
      const calendarUrl = getGoogleCalendarEventUrl(event);

      const fields = [
        { label: 'Event Title', value: event.title || event.summary },
        { label: 'Calendar', value: event._calendarType, type: 'badge', badgeClass: 'bg-gray-100 text-gray-600' },
        { label: 'Status', value: event.status },
        { label: 'Start', value: startDate, type: event.isAllDay ? 'date' : 'datetime' },
        { label: 'End', value: endDate, type: event.isAllDay ? 'date' : 'datetime' },
        { label: 'Location', value: event.location },
        { label: 'Video Link', value: event.meetLink, type: 'link', linkLabel: 'Join Meeting' },
        { label: 'Attendees', value: event.attendees?.map(a => a.email || a.displayName || a), type: 'list' },
        { label: 'Description', value: event.description, type: 'pre' },
        { label: 'Google Calendar', value: calendarUrl, type: 'link', linkLabel: 'Open in Google Calendar' }
      ];

      const isPast = startDate ? new Date(startDate) < new Date() : false;

      showDetailModal({
        id: 'event-detail-modal',
        title: event.title || event.summary || 'Event',
        subtitle: startDate ? (event.isAllDay ? formatDate(startDate) : `${formatDate(startDate)} at ${new Date(startDate).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`) : null,
        badge: isPast ? 'Past' : (event._calendarType || null),
        badgeClass: isPast ? 'bg-gray-200 text-gray-500' : 'bg-amber-500/20 text-amber-600',
        fields: fields
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADD SOURCE STEP MODAL - Select a data source to add as a step
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Available sources for the source step modal
    let availableSources = [];

    function setAvailableSources(sources) {
      availableSources = Array.isArray(sources) ? sources : [];
    }

    function showAddSourceStepModal(options = {}) {
      const { onConfirm, onCancel, sources } = options;

      // Use provided sources or fall back to availableSources
      const sourceList = Array.isArray(sources) ? sources : availableSources;

      // Build select options
      const optionsHtml = sourceList.map(source => {
        const label = source.label || source.name || source;
        const value = source.value || source.id || source;
        const recordCount = source.recordCount ? ` (${source.recordCount} records)` : '';
        return `<option value="${escapeHtml(String(value))}">${escapeHtml(label)}${recordCount}</option>`;
      }).join('');

      const content = `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-2">Select Source</label>
            <select id="source-step-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
              ${optionsHtml || '<option value="">No sources available</option>'}
            </select>
          </div>
        </div>
      `;

      // Create wrapper callbacks that get the selected value
      const wrappedOnConfirm = () => {
        const select = document.getElementById('source-step-select');
        const selectedValue = select ? select.value : null;
        const selectedSource = sourceList.find(s =>
          (s.value || s.id || s) === selectedValue
        );

        if (typeof onConfirm === 'function') {
          onConfirm(selectedSource, selectedValue);
        }
      };

      showModal({
        id: 'add-source-step-modal',
        title: 'Add Source Step',
        content: content,
        onConfirm: wrappedOnConfirm,
        onCancel: typeof onCancel === 'function' ? onCancel : null,
        confirmText: 'Save',
        cancelText: 'Cancel'
      });
    }

    function resetViewAndRefresh() {
      resetViewPrefs(settingsCurrentView);
      renderSettingsModal();
      if (settingsCurrentView === currentView && window.currentData) {
        renderData(window.currentData);
      }
    }

    function resetAllAndRefresh() {
      resetFieldPrefs();
      renderSettingsModal();
      if (window.currentData) {
        renderData(window.currentData);
      }
    }

    function getRecordId() {
      // 1. Check query parameters (standard approach)
      const params = new URLSearchParams(window.location.search);
      const queryRecordId = params.get('recordId');
      if (queryRecordId) return queryRecordId;

      // 2. Check URL path for Softr detail page pattern (e.g., /page-name/recXXXXXX)
      // Airtable record IDs start with 'rec' followed by alphanumeric characters
      const pathSegments = window.location.pathname.split('/').filter(Boolean);
      for (const segment of pathSegments.reverse()) {
        if (/^rec[a-zA-Z0-9]+$/.test(segment)) {
          return segment;
        }
      }

      // 3. Check hash for record ID (some Softr configurations)
      const hash = window.location.hash.replace('#', '');
      if (/^rec[a-zA-Z0-9]+$/.test(hash)) {
        return hash;
      }

      // 4. Check hash as query params (e.g., #recordId=recXXX)
      if (hash.includes('=')) {
        const hashParams = new URLSearchParams(hash);
        const hashRecordId = hashParams.get('recordId');
        if (hashRecordId) return hashRecordId;
      }

      return null;
    }

    function formatDate(dateStr) {
      if (!dateStr) return null;
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatDateLong(dateStr) {
      if (!dateStr) return null;
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    }

    function formatPhone(phone) {
      if (!phone) return null;
      const digits = String(phone).replace(/\D/g, '');
      if (digits.length === 10) {
        return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
      }
      if (digits.length === 11 && digits[0] === '1') {
        return `(${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7)}`;
      }
      return phone;
    }

    // Helper to get event start date with fallbacks for different field names
    function getEventStartDate(event) {
      return event.startDateTime || event.dateTime || event.Date || event.Start || event['Start Time'] || null;
    }

    // Helper to get event end date with fallbacks for different field names
    function getEventEndDate(event) {
      return event.endDateTime || event.End || event['End Time'] || null;
    }

    function getAge(dob) {
      if (!dob) return null;
      const birth = new Date(dob);
      const now = new Date();
      let age = now.getFullYear() - birth.getFullYear();
      const m = now.getMonth() - birth.getMonth();
      if (m < 0 || (m === 0 && now.getDate() < birth.getDate())) age--;
      return age;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function val(v) {
      if (Array.isArray(v)) return v[0];
      return v;
    }

    function list(v) {
      if (Array.isArray(v)) return v.join(', ');
      return v;
    }

    function formatFlatpackValue(value) {
      if (Array.isArray(value)) {
        return value.map(item => typeof item === 'object' && item !== null ? JSON.stringify(item) : String(item)).join(', ');
      } else if (typeof value === 'boolean') {
        return value ? 'Yes' : 'No';
      } else if (typeof value === 'object' && value !== null) {
        return JSON.stringify(value);
      }
      return String(value);
    }

    // Clean up flatpack field keys for display
    function formatFlatpackKey(key) {
      // Label mappings for cleaner display
      const keyMappings = {
        'matter matterid': 'Matter ID',
        'matter displaynumber': 'Display #',
        'matter clientid': 'Client ID',
        'matter clientname': 'Client',
        'matter airtablerecordid': 'Record ID',
        'matter description': 'Description',
        'matter status': 'Status',
        'matter mappedstatus': 'Mapped Status',
        'matter opendate': 'Open Date',
        'matter closedate': 'Close Date',
        'matter notes': 'Notes',
        'matter notecount': 'Note Count',
        'bahr import matterid': 'BAHR Matter ID',
        'bahr import displaynumber': 'BAHR Display #',
        'bahr import clientid': 'BAHR Client ID',
        'bahr import clientname': 'BAHR Client',
        'bahr import description': 'BAHR Description',
        'bahr import status': 'BAHR Status',
      };

      // Normalize the key for lookup
      const normalizedKey = key.replace(/[_.]/g, ' ').toLowerCase().trim();

      // Check for exact mapping
      if (keyMappings[normalizedKey]) {
        return keyMappings[normalizedKey];
      }

      // Fallback: clean up the key
      let cleaned = key
        .replace(/[_.]/g, ' ')           // Replace underscores/dots with spaces
        .replace(/\b(matter|bahr import)\s+/gi, '')  // Remove redundant prefixes
        .replace(/\s+/g, ' ')            // Normalize whitespace
        .trim();

      // Title case
      cleaned = cleaned.replace(/\b\w/g, l => l.toUpperCase());

      return cleaned || key;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLATPACK JSON PARSING - Extract nested JSON into unique fields
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function parseFlatpack(value) {
      // Handle null/undefined
      if (!value) return null;

      // If it's an array, parse each element and merge results
      if (Array.isArray(value)) {
        const results = value
          .map(v => parseFlatpack(v))
          .filter(Boolean);
        if (results.length === 0) return null;
        if (results.length === 1) return results[0];
        // Merge multiple flatpack objects
        return results.reduce((acc, obj) => ({ ...acc, ...obj }), {});
      }

      // If already an object, return as-is
      if (typeof value === 'object') return value;

      // If string, try to parse as JSON
      if (typeof value === 'string') {
        try {
          const parsed = JSON.parse(value);
          if (typeof parsed === 'object' && parsed !== null) {
            return parsed;
          }
        } catch (e) {
          // Not valid JSON, return null
        }
      }

      return null;
    }

    function extractFlatpackFields(record, flatpackFieldName, prefix = '') {
      // Extract and parse flatpack field
      const flatpackValue = record[flatpackFieldName];
      const parsed = parseFlatpack(flatpackValue);

      if (!parsed) return {};

      // Flatten nested objects with dot notation for keys
      const extracted = {};
      const flatten = (obj, parentKey = '') => {
        for (const [key, value] of Object.entries(obj)) {
          const newKey = parentKey ? `${parentKey}.${key}` : (prefix ? `${prefix}_${key}` : key);
          if (value !== null && typeof value === 'object' && !Array.isArray(value)) {
            flatten(value, newKey);
          } else {
            extracted[newKey] = value;
          }
        }
      };

      flatten(parsed);
      return extracted;
    }

    /**
     * Flatten an Airtable export record that has fields wrapped in a `fields` object.
     * Merges id, createdTime, and all fields.* properties to the top level.
     * @param {Object} record - Record that may have { id, createdTime, fields: {...} } structure
     * @returns {Object} Flattened record with all properties at top level
     */
    function flattenAirtableRecord(record) {
      if (!record || typeof record !== 'object') return record;

      // If record has a fields object, flatten it
      if (record.fields && typeof record.fields === 'object') {
        const { fields, ...rest } = record;
        return { ...rest, ...fields };
      }

      return record;
    }

    /**
     * Normalize an array of records to handle both flat and nested formats.
     * Supports: flat records, { records: [...] } format, and Airtable export { fields: {...} } format.
     * @param {Array} records - Raw records array
     * @returns {Array} Normalized flat array of records with fields at top level
     */
    function normalizeRecordArray(records) {
      if (!records || !Array.isArray(records)) return [];

      const normalized = [];

      records.forEach(recordOrGroup => {
        // Handle nested { records: [...] } structure
        if (recordOrGroup.records && Array.isArray(recordOrGroup.records)) {
          recordOrGroup.records.forEach(record => {
            normalized.push(flattenAirtableRecord(record));
          });
        }
        // Handle single record (flat or with fields wrapper)
        else {
          normalized.push(flattenAirtableRecord(recordOrGroup));
        }
      });

      return normalized;
    }

    function processDataWithFlatpack(data) {
      // Normalize all record arrays to handle Airtable export format with fields wrapper
      // This handles the { id, createdTime, fields: {...} } structure from Airtable webhooks

      // Normalize client (single record, not array)
      if (data.client) {
        data.client = flattenAirtableRecord(data.client);
      }

      // Normalize all array collections
      const arrayCollections = ['cases', 'applications', 'events', 'hearings', 'notes', 'caseNotes', 'caseEvents', 'calendarEvents'];
      arrayCollections.forEach(key => {
        if (data[key] && Array.isArray(data[key])) {
          data[key] = normalizeRecordArray(data[key]);
        }
      });

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // NORMALIZE NOTES: Handle both 'notes' and 'caseNotes' from webhook
      // The app expects 'notes', but webhooks may send 'caseNotes' or both
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      // Extract arrays (handle nested structures from Xano: {items:[...]}, {data:[...]}, etc.)
      const extractArray = (val) => {
        if (!val) return [];
        if (Array.isArray(val)) return val;
        if (val.items && Array.isArray(val.items)) return val.items;
        if (val.data && Array.isArray(val.data)) return val.data;
        if (val.records && Array.isArray(val.records)) return val.records;
        return [];
      };

      const notesFromNotes = extractArray(data.notes);
      const notesFromCaseNotes = extractArray(data.caseNotes);

      // Merge both sources, avoiding duplicates by id
      const seenIds = new Set();
      const mergedNotes = [];

      [...notesFromNotes, ...notesFromCaseNotes].forEach(note => {
        const noteId = note.id || note._id || note.RecordId || JSON.stringify(note);
        if (!seenIds.has(noteId)) {
          seenIds.add(noteId);
          mergedNotes.push(note);
        }
      });

      // Set both keys so the app works regardless of which one it uses
      data.notes = mergedNotes;
      data.caseNotes = mergedNotes;

      // Log for debugging (remove in production)
      if (mergedNotes.length > 0) {
        console.log(`ğŸ“ Notes loaded: ${mergedNotes.length} (from notes: ${notesFromNotes.length}, from caseNotes: ${notesFromCaseNotes.length})`);
      }

      // Process client flatpack fields
      if (data.client) {
        // Extract Matter_Flatpack from client (from Case Master View // Activities)
        const clientFlatpack = extractFlatpackFields(
          data.client,
          'Matter_Flatpack (from Case Master View // Activities)',
          'matter'
        );
        if (Object.keys(clientFlatpack).length > 0) {
          data.client._flatpack = clientFlatpack;
        }

        // Also check for bahr_import_flatpack_data
        const bahrFlatpack = extractFlatpackFields(
          data.client,
          'bahr_import_flatpack_data',
          'bahr_import'
        );
        if (Object.keys(bahrFlatpack).length > 0) {
          data.client._bahr_flatpack = bahrFlatpack;
        }
      }

      // Process case flatpack fields
      if (data.cases && Array.isArray(data.cases)) {
        data.cases = data.cases.map(caseRecord => {
          const caseFlatpack = extractFlatpackFields(
            caseRecord,
            'Matter_Flatpack',
            ''
          );
          if (Object.keys(caseFlatpack).length > 0) {
            caseRecord._flatpack = caseFlatpack;
          }
          return caseRecord;
        });
      }

      return data;
    }

    function pluralize(n, singular, plural) {
      return n === 1 ? singular : (plural || singular + 's');
    }

    function getDaysUrgency(days) {
      if (typeof days !== 'number') return null;
      if (days <= 14) return { level: 'critical', label: 'urgent', class: 'text-red-600 font-bold' };
      if (days <= 30) return { level: 'high', label: 'soon', class: 'text-red-600' };
      if (days <= 60) return { level: 'medium', label: 'upcoming', class: 'text-amber-600' };
      return { level: 'low', label: '', class: 'text-gray-500' };
    }

    function toggleSection(sectionId) {
      const content = document.getElementById(`content-${sectionId}`);
      const arrow = document.getElementById(`arrow-${sectionId}`);
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
      } else {
        content.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
      }
    }

    function toggleNotesSortOrder() {
      notesSortOrder = notesSortOrder === 'asc' ? 'desc' : 'asc';
      // Re-render the current view to apply new sort order
      if (window._lastLoadedData) {
        const data = transformData(window._lastLoadedData);
        renderView(data);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NOTES LINKING & INDEXING UTILITIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Build an index of notes by their linked entities
     * Returns { byCase: {caseId: [notes]}, byApplication: {...}, byEvent: {...}, unlinked: [notes] }
     */
    function buildNoteIndex(notes, cases, applications, events) {
      const index = {
        byCase: {},
        byApplication: {},
        byEvent: {},
        unlinked: [],
        all: notes || []
      };

      if (!notes || notes.length === 0) return index;

      // Build lookup maps for matching
      const caseIds = new Set((cases || []).map(c => c.id).filter(Boolean));
      const appIds = new Set();
      (applications || []).forEach(appOrGroup => {
        // Handle nested structure: { records: [...] }
        if (appOrGroup.records && Array.isArray(appOrGroup.records)) {
          appOrGroup.records.forEach(app => {
            if (app.id) appIds.add(app.id);
          });
        }
        // Handle flat structure: { id: ..., Application: ... }
        else if (appOrGroup.id) {
          appIds.add(appOrGroup.id);
        }
      });
      const eventIds = new Set((events || []).map(e => e.id || e.eventId).filter(Boolean));

      notes.forEach(note => {
        let linked = false;

        // Link by matter_id to cases
        if (note.matter_id) {
          if (!index.byCase[note.matter_id]) index.byCase[note.matter_id] = [];
          index.byCase[note.matter_id].push(note);
          linked = true;
        }

        // Link by eventId to events
        if (note.eventId) {
          if (!index.byEvent[note.eventId]) index.byEvent[note.eventId] = [];
          index.byEvent[note.eventId].push(note);
          linked = true;
        }

        // Link by RecordId (could be case, application, or event)
        if (note.RecordId) {
          if (caseIds.has(note.RecordId)) {
            if (!index.byCase[note.RecordId]) index.byCase[note.RecordId] = [];
            index.byCase[note.RecordId].push(note);
            linked = true;
          }
          if (appIds.has(note.RecordId)) {
            if (!index.byApplication[note.RecordId]) index.byApplication[note.RecordId] = [];
            index.byApplication[note.RecordId].push(note);
            linked = true;
          }
          if (eventIds.has(note.RecordId)) {
            if (!index.byEvent[note.RecordId]) index.byEvent[note.RecordId] = [];
            index.byEvent[note.RecordId].push(note);
            linked = true;
          }
        }

        if (!linked) {
          index.unlinked.push(note);
        }
      });

      return index;
    }

    /**
     * Get notes for a specific entity
     */
    function getNotesForEntity(noteIndex, entityType, entityId) {
      if (!noteIndex || !entityId) return [];
      const bucket = noteIndex[`by${entityType.charAt(0).toUpperCase() + entityType.slice(1)}`];
      return bucket ? (bucket[entityId] || []) : [];
    }

    /**
     * Render a compact notes table row
     */
    function renderCompactNoteRow(note) {
      const activity = note.Activity || 'â€”';
      const type = note.Type || '';
      const date = note.Date ? formatDate(note.Date) : '';
      const createdBy = note.Created_By || '';
      const description = (note.Description || '').substring(0, 80);
      const hasMore = (note.Description || '').length > 80;
      const matter = note.Matter || note.matter || '';
      const contact = note.Contact || '';
      const dueDate = note.Due_Date ? formatDate(note.Due_Date) : '';

      const typeColors = {
        'Call': 'bg-blue-100 text-blue-700',
        'Email': 'bg-green-100 text-green-700',
        'Meeting': 'bg-purple-100 text-purple-700',
        'Task': 'bg-amber-100 text-amber-700',
        'Case Note': 'bg-teal-100 text-teal-700',
        'Note': 'bg-gray-100 text-gray-600',
        'General': 'bg-gray-100 text-gray-600'
      };
      const typeClass = typeColors[type] || typeColors['General'];

      return `
        <tr class="border-b border-gray-100 hover:bg-gray-50/50 text-xs">
          <td class="py-2 px-3 text-gray-500 whitespace-nowrap">${escapeHtml(date)}</td>
          <td class="py-2 px-3">
            <span class="px-1.5 py-0.5 rounded text-xs ${typeClass}">${escapeHtml(type || 'Note')}</span>
          </td>
          <td class="py-2 px-3 font-medium text-gray-800">${escapeHtml(activity)}</td>
          <td class="py-2 px-3 text-gray-500 max-w-xs truncate">${escapeHtml(description)}${hasMore ? '...' : ''}</td>
          <td class="py-2 px-3 text-gray-400 whitespace-nowrap max-w-[120px] truncate" title="${escapeHtml(matter)}">${escapeHtml(matter)}</td>
          <td class="py-2 px-3 text-gray-400 whitespace-nowrap">${escapeHtml(contact)}</td>
          <td class="py-2 px-3 text-gray-400 whitespace-nowrap">${escapeHtml(createdBy)}</td>
          ${dueDate ? `<td class="py-2 px-3 text-amber-600 whitespace-nowrap">${escapeHtml(dueDate)}</td>` : '<td class="py-2 px-3 text-gray-300">â€”</td>'}
        </tr>
      `;
    }

    /**
     * Render compact notes table for front page (collapsed by default)
     */
    function renderCompactNotesTable(notes) {
      const safeNotes = notes || [];
      const isEmpty = safeNotes.length === 0;

      // Sort by date descending (most recent first)
      const sortedNotes = [...safeNotes].sort((a, b) => {
        const dateA = a.Date || 0;
        const dateB = b.Date || 0;
        return dateB - dateA;
      });

      const rows = sortedNotes.map(renderCompactNoteRow).join('');

      const emptyStateHtml = isEmpty ? `
        <tr>
          <td colspan="8" class="py-8 px-4 text-center">
            <div class="text-gray-400 text-sm">No case notes recorded</div>
          </td>
        </tr>
      ` : '';

      return `
        <div id="section-notes-compact" class="bg-white rounded-lg border border-gray-200/50 overflow-hidden">
          <button onclick="toggleSection('notes-compact')" class="w-full flex items-center justify-between p-3 hover:bg-gray-50 transition-colors">
            <div class="flex items-center gap-2">
              <span class="w-6 h-6 rounded-full bg-teal-500/20 text-teal-600 flex items-center justify-center text-xs font-medium">${safeNotes.length}</span>
              <span class="text-sm font-medium text-gray-700">Recent Notes</span>
              <span class="text-xs text-gray-400">(chronological)</span>
            </div>
            <span id="arrow-notes-compact" class="text-gray-400 transition-transform text-xs" style="transform: rotate(0deg)">â–¼</span>
          </button>
          <div id="content-notes-compact" class="hidden border-t border-gray-200/50">
            <div class="overflow-x-auto">
              <table class="w-full text-left">
                <thead class="bg-gray-50/80 text-xs text-gray-500 uppercase tracking-wide">
                  <tr>
                    <th class="py-2 px-3 font-medium">Date</th>
                    <th class="py-2 px-3 font-medium">Type</th>
                    <th class="py-2 px-3 font-medium">Activity</th>
                    <th class="py-2 px-3 font-medium">Description</th>
                    <th class="py-2 px-3 font-medium">Matter</th>
                    <th class="py-2 px-3 font-medium">Contact</th>
                    <th class="py-2 px-3 font-medium">By</th>
                    <th class="py-2 px-3 font-medium">Due</th>
                  </tr>
                </thead>
                <tbody>${isEmpty ? emptyStateHtml : rows}</tbody>
              </table>
            </div>
            ${safeNotes.length > 10 ? `<div class="p-2 text-center border-t border-gray-100"><span class="text-xs text-gray-400">Showing all ${safeNotes.length} notes â€¢ See "Notes" section for full details</span></div>` : ''}
          </div>
        </div>
      `;
    }

    /**
     * Render contextual note cards for embedding under entities
     */
    function renderContextualNoteCards(notes, maxShow = 3) {
      if (!notes || notes.length === 0) return '';

      // Sort based on notesSortOrder
      const sortedNotes = [...notes].sort((a, b) => {
        const dateA = a.Date ? new Date(a.Date).getTime() : 0;
        const dateB = b.Date ? new Date(b.Date).getTime() : 0;
        return notesSortOrder === 'asc' ? dateA - dateB : dateB - dateA;
      });
      const displayNotes = sortedNotes.slice(0, maxShow);
      const remaining = sortedNotes.length - maxShow;

      const cardsHtml = displayNotes.map(note => {
        const activity = note.Activity || 'Note';
        const date = note.Date ? formatDate(note.Date) : '';
        const description = note.Description || '';
        const createdBy = note.Created_By || '';
        const type = note.Type || 'Note';
        const matter = note.Matter || note.matter || '';
        const contact = note.Contact || '';
        const dueDate = note.Due_Date ? formatDate(note.Due_Date) : '';
        const tags = note.tags || [];
        const source = note.source || '';

        const typeColors = {
          'Call': 'border-l-blue-400',
          'Email': 'border-l-green-400',
          'Meeting': 'border-l-purple-400',
          'Task': 'border-l-amber-400',
          'Case Note': 'border-l-teal-400',
          'Note': 'border-l-gray-300',
          'General': 'border-l-gray-300'
        };
        const borderClass = typeColors[type] || typeColors['General'];

        // Build metadata items for the card
        const metaItems = [];
        if (contact) metaItems.push(`Contact: ${escapeHtml(contact)}`);
        if (matter) metaItems.push(`Matter: ${escapeHtml(matter)}`);
        if (dueDate) metaItems.push(`<span class="text-amber-600">Due: ${escapeHtml(dueDate)}</span>`);
        if (source) metaItems.push(`<span class="italic">${escapeHtml(source)}</span>`);

        // Tags rendering
        const tagsHtml = tags.length > 0
          ? `<div class="flex flex-wrap gap-1 mt-1">${tags.slice(0, 3).map(tag =>
              `<span class="px-1 py-0.5 bg-gray-100 text-gray-500 rounded text-xs">${escapeHtml(tag)}</span>`
            ).join('')}${tags.length > 3 ? `<span class="text-gray-400 text-xs">+${tags.length - 3}</span>` : ''}</div>`
          : '';

        return `
          <div class="bg-gray-50/50 rounded border-l-2 ${borderClass} p-2 text-xs">
            <div class="flex items-center justify-between gap-2 mb-1">
              <span class="font-medium text-gray-700 truncate">${escapeHtml(activity)}</span>
              <span class="text-gray-400 whitespace-nowrap">${escapeHtml(date)}</span>
            </div>
            ${metaItems.length > 0 ? `<div class="flex flex-wrap gap-x-2 gap-y-0.5 text-gray-400 text-xs mb-1">${metaItems.join(' â€¢ ')}</div>` : ''}
            ${description ? `
              <details>
                <summary class="text-gray-400 cursor-pointer hover:text-gray-500 text-xs">View note</summary>
                <p class="mt-1 text-gray-500 whitespace-pre-wrap text-xs max-h-20 overflow-y-auto">${escapeHtml(description)}</p>
              </details>
            ` : ''}
            ${tagsHtml}
            ${createdBy ? `<span class="text-gray-400 text-xs">â€” ${escapeHtml(createdBy)}</span>` : ''}
          </div>
        `;
      }).join('');

      const moreHtml = remaining > 0
        ? `<div class="text-xs text-gray-400 text-center py-1">+ ${remaining} more note${remaining > 1 ? 's' : ''}</div>`
        : '';

      return `
        <div class="mt-2 space-y-1.5">
          <div class="text-xs text-gray-400 font-medium uppercase tracking-wide">Related Notes</div>
          ${cardsHtml}
          ${moreHtml}
        </div>
      `;
    }

    function switchView(view) {
      currentView = view;
      if (window.currentData) {
        renderData(window.currentData);
      }
    }

    function renderError(message) {
      document.getElementById('app').innerHTML = `
        <div class="max-w-6xl mx-auto">
          <div class="bg-red-50 border border-red-200 rounded-lg p-6 max-w-md mx-auto mt-12">
            <p class="text-red-600 font-medium">Error</p>
            <p class="text-red-600/70 text-sm mt-1">${escapeHtml(message)}</p>
          </div>
        </div>
      `;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BRIEF NARRATIVE - Executive summary style
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function generateBriefNarrative(data) {
      const { client, cases, applications, events, hearings, notes } = data;
      const lines = [];

      if (!client) {
        return ['<span class="text-gray-400">No client information available.</span>'];
      }

      // One-liner client intro
      const name = client['Client Name'] || client['Full_Name_Normal_Pretty'] || 'Unknown';
      const age = getAge(client.DOB);
      const country = client.Country;
      const aNum = client['A#'];

      let intro = isFieldVisible('client', 'name')
        ? `<strong class="text-gray-900">${escapeHtml(name)}</strong>`
        : '<strong class="text-gray-900">Client</strong>';

      const details = [];
      if (isFieldVisible('client', 'dob') && age) details.push(`${age}yo`);
      if (isFieldVisible('client', 'country') && country) details.push(`from ${escapeHtml(country)}`);
      if (isFieldVisible('client', 'aNumber') && aNum) details.push(`A# <span class="font-mono text-blue-600">${escapeHtml(aNum)}</span>`);
      if (details.length) intro += ` (${details.join(', ')})`;

      // SIJ status inline if present
      const sijStatus = client['SIJ Case Status'];
      if (isFieldVisible('client', 'sijStatus') && sijStatus) {
        const statusText = list(sijStatus);
        intro += ` â€” SIJ: <span class="text-amber-600">${escapeHtml(statusText)}</span>`;
      }

      lines.push(intro);

      // Client flatpack data summary (controlled by visibility)
      if (isFieldVisible('client', 'flatpack') && client._flatpack && Object.keys(client._flatpack).length > 0) {
        const flatpackSummary = Object.entries(client._flatpack)
          .filter(([key, value]) => value !== null && value !== undefined && value !== '')
          .filter(([key]) => {
            const lowerKey = key.toLowerCase();
            return !lowerKey.includes('flatpack') && !/merge[_.\s-]*history/i.test(lowerKey);
          })
          .slice(0, 3) // Show first 3 fields in brief view
          .map(([key, value]) => {
            const formattedKey = formatFlatpackKey(key);
            const formattedValue = formatFlatpackValue(value);
            return `<span class="text-cyan-600">${escapeHtml(formattedKey)}</span>: ${escapeHtml(formattedValue)}`;
          })
          .join(' Â· ');
        if (flatpackSummary) {
          lines.push(`<span class="text-gray-500 text-sm">${flatpackSummary}</span>`);
        }
      }

      // Cases summary
      if (cases && cases.length > 0) {
        const casesByType = {};
        cases.forEach(c => {
          // Use flatpack description if available, otherwise fall back to Description field
          const type = (c._flatpack && c._flatpack.description) || c.Description || 'Other';
          if (!casesByType[type]) casesByType[type] = [];
          casesByType[type].push(c);
        });

        if (isFieldVisible('cases', 'type')) {
          const typeSummary = Object.entries(casesByType)
            .map(([type, arr]) => `${arr.length} ${escapeHtml(type)}`)
            .join(', ');
          lines.push(`<span class="text-blue-600 font-medium">${cases.length} ${pluralize(cases.length, 'case')}</span>: ${typeSummary}`);
        } else {
          lines.push(`<span class="text-blue-600 font-medium">${cases.length} ${pluralize(cases.length, 'case')}</span>`);
        }

        // Urgent hearings
        if (isFieldVisible('cases', 'daysToHearing')) {
          const urgent = cases.filter(c => {
            const days = c['Days to Next Hearing'];
            return typeof days === 'number' && days <= 30;
          }).sort((a, b) => a['Days to Next Hearing'] - b['Days to Next Hearing']);

          if (urgent.length > 0) {
            const next = urgent[0];
            const days = next['Days to Next Hearing'];
            const urgency = getDaysUrgency(days);
            const hearingDate = isFieldVisible('cases', 'hearingDate') ? formatDate(val(next['Hearing Date/Time'])) : null;
            const caseType = isFieldVisible('cases', 'type') ? (next.Description || 'case') : 'case';

            let urgentLine = `<span class="${urgency.class}">Next hearing in ${days} ${pluralize(days, 'day')}</span>`;
            if (hearingDate) urgentLine += ` (${hearingDate})`;
            urgentLine += ` for ${escapeHtml(caseType)}`;

            const court = val(next['Court/Office']);
            if (isFieldVisible('cases', 'court') && court) urgentLine += ` at ${escapeHtml(court)}`;

            if (urgent.length > 1) {
              urgentLine += `. <span class="text-gray-500">${urgent.length - 1} other ${pluralize(urgent.length - 1, 'hearing')} within 30 days.</span>`;
            }

            lines.push(urgentLine);
          }
        }
      } else {
        lines.push('<span class="text-gray-400">No active cases.</span>');
      }

      // Applications summary
      if (applications && applications.length > 0) {
        const appsByType = {};
        applications.forEach(app => {
          const type = app.Application || app.Name || 'Other';
          if (!appsByType[type]) appsByType[type] = [];
          appsByType[type].push(app);
        });

        if (isFieldVisible('applications', 'type')) {
          const appTypeSummary = Object.entries(appsByType)
            .map(([type, arr]) => {
              const statuses = isFieldVisible('applications', 'status')
                ? [...new Set(arr.map(a => a.Status).filter(Boolean))]
                : [];
              const statusStr = statuses.length > 0 ? ` (${statuses.join(', ')})` : '';
              return `<span class="text-purple-600">${escapeHtml(type)}</span>${statusStr}`;
            })
            .join(', ');
          lines.push(`<span class="text-purple-600 font-medium">${applications.length} ${pluralize(applications.length, 'application')}</span>: ${appTypeSummary}`);
        } else {
          lines.push(`<span class="text-purple-600 font-medium">${applications.length} ${pluralize(applications.length, 'application')}</span>`);
        }
      }

      // Calendar events (combined hearings and events)
      const allCalendarItems = [...(hearings || []), ...(events || [])];
      if (allCalendarItems.length > 0) {
        const upcomingEvents = allCalendarItems
          .filter(e => getEventStartDate(e) && new Date(getEventStartDate(e)) >= new Date())
          .sort((a, b) => new Date(getEventStartDate(a)) - new Date(getEventStartDate(b)));

        if (upcomingEvents.length > 0) {
          const nextEvent = upcomingEvents[0];
          const eventDate = isFieldVisible('events', 'dateTime') ? formatDate(getEventStartDate(nextEvent)) : '';
          const eventTitle = isFieldVisible('events', 'title') ? (nextEvent.title || nextEvent.summary || 'Upcoming event') : 'Event';
          const location = (isFieldVisible('events', 'location') && nextEvent.location) ? ` at ${escapeHtml(nextEvent.location)}` : '';

          let eventLine = `<span class="text-amber-600 font-medium">Next event:</span> ${escapeHtml(eventTitle)}`;
          if (eventDate) eventLine += ` on ${eventDate}`;
          eventLine += location;
          lines.push(eventLine);

          if (upcomingEvents.length > 1) {
            lines.push(`<span class="text-gray-500">${upcomingEvents.length - 1} more upcoming ${pluralize(upcomingEvents.length - 1, 'event')}.</span>`);
          }
        } else {
          lines.push(`<span class="text-amber-600">${allCalendarItems.length} ${pluralize(allCalendarItems.length, 'event')} on file.</span>`);
        }
      }

      // Notes summary
      if (notes && notes.length > 0) {
        const notesByType = {};
        notes.forEach(note => {
          const type = note.Type || 'General';
          if (!notesByType[type]) notesByType[type] = [];
          notesByType[type].push(note);
        });

        if (isFieldVisible('notes', 'type')) {
          const typeSummary = Object.entries(notesByType)
            .map(([type, arr]) => `<span class="text-teal-600">${escapeHtml(type)}</span> (${arr.length})`)
            .join(', ');
          lines.push(`<span class="text-teal-600 font-medium">${notes.length} ${pluralize(notes.length, 'note')}</span>: ${typeSummary}`);
        } else {
          lines.push(`<span class="text-teal-600 font-medium">${notes.length} ${pluralize(notes.length, 'note')}</span> on file.`);
        }
      }

      return lines;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DETAILED NARRATIVE - Full prose disclosure
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function generateDetailedNarrative(data) {
      const { client, cases, applications, events, hearings, notes } = data;
      const sections = [];

      if (!client) {
        return ['<span class="text-gray-400">No client information available.</span>'];
      }

      // â”€â”€â”€ Client Profile â”€â”€â”€
      const name = client['Client Name'] || client['Full_Name_Normal_Pretty'] || 'The client';
      const age = getAge(client.DOB);
      const dob = formatDateLong(client.DOB);
      const country = client.Country;
      const aNum = client['A#'];

      let profile = isFieldVisible('client', 'name')
        ? `<strong class="text-gray-900">${escapeHtml(name)}</strong>`
        : '<strong class="text-gray-900">The client</strong>';

      const showAge = isFieldVisible('client', 'dob') && age;
      const showCountry = isFieldVisible('client', 'country') && country;

      if (showAge && showCountry) {
        profile += ` is a ${age}-year-old national of ${escapeHtml(country)}`;
      } else if (showAge) {
        profile += ` is ${age} years old`;
      } else if (showCountry) {
        profile += ` is a national of ${escapeHtml(country)}`;
      }

      if (isFieldVisible('client', 'dob') && dob) {
        profile += `, born ${dob}`;
      }

      if (isFieldVisible('client', 'aNumber') && aNum) {
        profile += `. Their Alien Registration Number is <span class="font-mono text-blue-600">${escapeHtml(aNum)}</span>`;
      }

      profile += '.';
      sections.push(profile);

      // Contact info
      const phone = client['Phone Number'];
      const addr = client['Address Line 1'];
      const city = client.City;
      const state = client['State Formula'];
      const zip = client['Zip (5)'];

      const showPhone = isFieldVisible('client', 'phone') && phone;
      const showAddr = isFieldVisible('client', 'address') && addr;

      if (showPhone || showAddr) {
        let contact = '';
        if (showPhone) {
          contact += `They can be contacted at <span class="font-mono text-emerald-600">${escapeHtml(formatPhone(phone))}</span>`;
        }
        if (showAddr) {
          const fullAddr = [addr, city, state, zip].filter(Boolean).join(', ');
          contact += showPhone ? ` and reside` : 'They reside';
          contact += ` at ${escapeHtml(fullAddr)}`;
        }
        contact += '.';
        sections.push(contact);
      }

      // Status and tags
      const sijStatus = client['SIJ Case Status'];
      const tags = (client['CM Tags'] || []).filter(Boolean);

      if (isFieldVisible('client', 'sijStatus') && sijStatus) {
        const statusText = list(sijStatus);
        sections.push(`Their Special Immigrant Juvenile (SIJ) case status is <span class="px-2 py-0.5 bg-amber-500/20 text-amber-600 rounded">${escapeHtml(statusText)}</span>.`);
      }

      if (isFieldVisible('client', 'tags') && tags.length > 0) {
        const tagSpans = tags.map(t => `<span class="px-2 py-0.5 bg-purple-500/20 text-purple-600 rounded text-sm">${escapeHtml(t)}</span>`).join(' ');
        sections.push(`Case management notes: ${tagSpans}`);
      }

      // â”€â”€â”€ Client Flatpack Data (controlled by visibility) â”€â”€â”€
      if (isFieldVisible('client', 'flatpack') && client._flatpack && Object.keys(client._flatpack).length > 0) {
        sections.push(`<br><span class="text-lg font-semibold text-gray-800">Additional Matter Details</span>`);
        const flatpackItems = Object.entries(client._flatpack)
          .filter(([key, value]) => value !== null && value !== undefined && value !== '')
          .filter(([key]) => {
            const lowerKey = key.toLowerCase();
            return !lowerKey.includes('flatpack') && !/merge[_.\s-]*history/i.test(lowerKey);
          })
          .map(([key, value]) => {
            const formattedKey = formatFlatpackKey(key);
            const formattedValue = formatFlatpackValue(value);
            return `
              <div class="grid grid-cols-[auto_1fr] gap-x-3 py-1">
                <span class="text-cyan-600 font-medium whitespace-nowrap">${escapeHtml(formattedKey)}</span>
                <span class="text-gray-800">${escapeHtml(formattedValue)}</span>
              </div>`;
          });
        sections.push(`<div class="mt-2 border-l-2 border-cyan-200 pl-3">${flatpackItems.join('')}</div>`);
      }

      // â”€â”€â”€ Cases â”€â”€â”€
      if (cases && cases.length > 0) {
        const casesByType = {};
        cases.forEach(c => {
          // Use flatpack description if available, otherwise fall back to Description field
          const type = (c._flatpack && c._flatpack.description) || c.Description || 'Other';
          if (!casesByType[type]) casesByType[type] = [];
          casesByType[type].push(c);
        });

        const typeCount = Object.keys(casesByType).length;
        sections.push(`<br><span class="text-lg font-semibold text-gray-800">Case Portfolio</span>`);

        if (isFieldVisible('cases', 'type')) {
          sections.push(`This client has <span class="text-blue-600 font-semibold">${cases.length} active ${pluralize(cases.length, 'case')}</span> across ${typeCount} ${pluralize(typeCount, 'category', 'categories')}.`);
        } else {
          sections.push(`This client has <span class="text-blue-600 font-semibold">${cases.length} active ${pluralize(cases.length, 'case')}</span>.`);
        }

        // Detail each case type
        for (const [type, typeCases] of Object.entries(casesByType)) {
          if (isFieldVisible('cases', 'type')) {
            sections.push(`<br><span class="text-gray-800 font-medium border-b border-gray-300 pb-1">${escapeHtml(type)}</span> <span class="text-gray-400">(${typeCases.length})</span>`);
          }

          typeCases.forEach((c, idx) => {
            const court = val(c['Court/Office']);
            const judge = c['Judge text'];
            const hearing = val(c['Hearing Date/Time']);
            const days = c['Days to Next Hearing'];

            // Build case narrative
            let caseText = '';

            if (isFieldVisible('cases', 'court') && court) {
              caseText += `Case pending at <span class="text-gray-800">${escapeHtml(court)}</span>`;
            } else {
              caseText += 'Case pending';
            }

            if (isFieldVisible('cases', 'judge') && judge) {
              caseText += ` before <span class="text-gray-800">Judge ${escapeHtml(judge)}</span>`;
            }

            caseText += '.';

            // Hearing info
            if (isFieldVisible('cases', 'hearingDate') && hearing) {
              const hearingDate = formatDateLong(hearing);
              const urgency = getDaysUrgency(days);

              if (isFieldVisible('cases', 'daysToHearing') && typeof days === 'number') {
                if (days <= 14) {
                  caseText += ` <span class="${urgency.class}">Hearing in ${days} ${pluralize(days, 'day')} (${hearingDate})</span> â€” immediate preparation required.`;
                } else if (days <= 30) {
                  caseText += ` <span class="${urgency.class}">Next hearing on ${hearingDate} (${days} days)</span>.`;
                } else if (days <= 60) {
                  caseText += ` <span class="${urgency.class}">Hearing scheduled for ${hearingDate} (${days} days)</span>.`;
                } else {
                  caseText += ` Hearing scheduled for ${hearingDate} (${days} days).`;
                }
              } else if (hearingDate) {
                caseText += ` Next hearing on ${hearingDate}.`;
              }
            }

            sections.push(caseText);

            // Flatpack fields for this case (controlled by visibility)
            if (isFieldVisible('cases', 'flatpack') && c._flatpack && Object.keys(c._flatpack).length > 0) {
              const flatpackFields = Object.entries(c._flatpack)
                .filter(([key, value]) => key !== 'description' && value !== null && value !== undefined && value !== '')
                .filter(([key]) => {
                  const lowerKey = key.toLowerCase();
                  return !lowerKey.includes('flatpack') && !/merge[_.\s-]*history/i.test(lowerKey);
                })
                .map(([key, value]) => {
                  const formattedKey = formatFlatpackKey(key);
                  const formattedValue = formatFlatpackValue(value);
                  return `<span class="text-cyan-600">${escapeHtml(formattedKey)}</span>: ${escapeHtml(formattedValue)}`;
                });
              if (flatpackFields.length > 0) {
                sections.push(`<span class="text-sm text-gray-500 ml-2">${flatpackFields.join(' Â· ')}</span>`);
              }
            }

            // Notes
            if (isFieldVisible('cases', 'notes') && c['Case Notes'] && c['Case Notes'].trim()) {
              sections.push(`<details class="ml-4 my-1"><summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-500">Case notes</summary><pre class="mt-2 p-3 bg-white/50 rounded text-xs text-gray-500 whitespace-pre-wrap max-h-48 overflow-y-auto">${escapeHtml(c['Case Notes'])}</pre></details>`);
            }
          });
        }

        // â”€â”€â”€ Timeline Summary â”€â”€â”€
        if (isFieldVisible('cases', 'daysToHearing')) {
          const allWithHearings = cases
            .filter(c => typeof c['Days to Next Hearing'] === 'number')
            .sort((a, b) => a['Days to Next Hearing'] - b['Days to Next Hearing']);

          const critical = allWithHearings.filter(c => c['Days to Next Hearing'] <= 14);
          const urgent = allWithHearings.filter(c => c['Days to Next Hearing'] > 14 && c['Days to Next Hearing'] <= 30);
          const upcoming = allWithHearings.filter(c => c['Days to Next Hearing'] > 30 && c['Days to Next Hearing'] <= 60);

          if (critical.length > 0 || urgent.length > 0 || upcoming.length > 0) {
            sections.push(`<br><span class="text-lg font-semibold text-gray-800">Timeline Overview</span>`);

            const alerts = [];
            if (critical.length > 0) {
              alerts.push(`<span class="text-red-600 font-bold">${critical.length} ${pluralize(critical.length, 'hearing')} within 2 weeks requiring immediate attention</span>`);
            }
            if (urgent.length > 0) {
              alerts.push(`<span class="text-red-600">${urgent.length} ${pluralize(urgent.length, 'hearing')} within 30 days</span>`);
            }
            if (upcoming.length > 0) {
              alerts.push(`<span class="text-amber-600">${upcoming.length} ${pluralize(upcoming.length, 'hearing')} within 60 days</span>`);
            }

            sections.push(alerts.join(' Â· '));
          }
        }
      } else {
        sections.push(`<br><span class="text-gray-400">No active cases currently on file for this client.</span>`);
      }

      // â”€â”€â”€ Applications â”€â”€â”€
      if (applications && applications.length > 0) {
        sections.push(`<br><span class="text-lg font-semibold text-gray-800">Applications</span>`);

        const appsByType = {};
        applications.forEach(app => {
          const type = app.Application || 'Other';
          if (!appsByType[type]) appsByType[type] = [];
          appsByType[type].push(app);
        });

        for (const [type, typeApps] of Object.entries(appsByType)) {
          if (isFieldVisible('applications', 'type')) {
            sections.push(`<span class="text-purple-600 font-medium">${escapeHtml(type)}</span> <span class="text-gray-400">(${typeApps.length})</span>`);
          }

          typeApps.forEach(app => {
            const parts = [];

            // Application name/matter
            if (isFieldVisible('applications', 'name') && app.Name) {
              parts.push(`<span class="text-gray-800">${escapeHtml(app.Name)}</span>`);
            }

            // Status with color coding
            if (isFieldVisible('applications', 'status') && app.Status) {
              const statusColors = {
                'Engaged': 'text-green-400',
                'Potential': 'text-amber-600',
                'Filed': 'text-blue-600',
                'Pending': 'text-amber-600',
                'Approved': 'text-emerald-600',
                'Denied': 'text-red-600'
              };
              const statusClass = statusColors[app.Status] || 'text-gray-700';
              parts.push(`Status: <span class="${statusClass}">${escapeHtml(app.Status)}</span>`);
            }

            // Receipt number
            if (isFieldVisible('applications', 'receiptNumber') && app['Receipt Number']) {
              parts.push(`Receipt: <span class="font-mono text-blue-600">${escapeHtml(app['Receipt Number'])}</span>`);
            }

            // Cert County/State
            if (isFieldVisible('applications', 'certCounty') && app['Cert County/State']) {
              parts.push(`County/State: ${escapeHtml(app['Cert County/State'])}`);
            }

            if (parts.length > 0) {
              sections.push(parts.join(' Â· '));
            }

            // Notes
            if (isFieldVisible('applications', 'notes') && app.Notes && app.Notes.trim()) {
              sections.push(`<details class="ml-4 my-1"><summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-500">Application notes</summary><pre class="mt-2 p-3 bg-white/50 rounded text-xs text-gray-500 whitespace-pre-wrap max-h-48 overflow-y-auto">${escapeHtml(app.Notes)}</pre></details>`);
            }
          });
        }
      }

      // â”€â”€â”€ Calendar Events â”€â”€â”€
      const allCalendarItems = [...(hearings || []), ...(events || [])];
      if (allCalendarItems.length > 0) {
        sections.push(`<br><span class="text-lg font-semibold text-gray-800">Scheduled Events</span>`);

        // Sort by date
        const sortedItems = allCalendarItems
          .filter(item => getEventStartDate(item))
          .sort((a, b) => new Date(getEventStartDate(a)) - new Date(getEventStartDate(b)));

        const now = new Date();
        const upcomingItems = sortedItems.filter(item => new Date(getEventStartDate(item)) >= now);
        const pastItems = sortedItems.filter(item => new Date(getEventStartDate(item)) < now);

        if (upcomingItems.length > 0) {
          sections.push(`<span class="text-amber-600 font-medium">Upcoming (${upcomingItems.length})</span>`);

          upcomingItems.forEach(item => {
            const eventTitle = item.title || item.summary || 'Event';
            const dateStr = formatDateLong(getEventStartDate(item));

            const locationStr = (isFieldVisible('events', 'location') && item.location)
              ? ` at <span class="text-gray-700">${escapeHtml(item.location)}</span>`
              : '';
            const calType = (isFieldVisible('events', 'calendarType') && item._calendarType)
              ? `<span class="text-xs px-1 py-0.5 bg-gray-100/50 text-gray-500 rounded">${escapeHtml(item._calendarType)}</span> `
              : '';

            let eventLine = calType;
            if (isFieldVisible('events', 'title')) {
              eventLine += `<span class="text-gray-800">${escapeHtml(eventTitle)}</span>`;
            }
            if (isFieldVisible('events', 'dateTime')) {
              eventLine += ` on ${dateStr}`;
            }
            eventLine += locationStr;

            // Meet link
            if (isFieldVisible('events', 'meetLink') && item.meetLink) {
              eventLine += ` <a href="${escapeHtml(item.meetLink)}" target="_blank" class="text-blue-600 hover:underline text-sm">[Video Link]</a>`;
            }

            sections.push(eventLine);

            // Description
            if (isFieldVisible('events', 'description') && item.description && item.description.trim()) {
              sections.push(`<details class="ml-4 my-1"><summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-500">Event details</summary><pre class="mt-2 p-3 bg-white/50 rounded text-xs text-gray-500 whitespace-pre-wrap max-h-48 overflow-y-auto">${escapeHtml(item.description)}</pre></details>`);
            }

            // Attendees
            if (isFieldVisible('events', 'attendees') && item.attendees && item.attendees.length > 0) {
              const attendeeList = item.attendees.map(a => a.email || a.displayName || a).join(', ');
              sections.push(`<span class="text-xs text-gray-400 ml-4">Attendees: ${escapeHtml(attendeeList)}</span>`);
            }
          });
        }

        if (pastItems.length > 0) {
          sections.push(`<br><span class="text-gray-500 font-medium">Past Events (${pastItems.length})</span>`);

          pastItems.forEach(item => {
            const eventTitle = item.title || item.summary || 'Event';
            const dateStr = formatDateLong(getEventStartDate(item));

            const locationStr = (isFieldVisible('events', 'location') && item.location)
              ? ` at <span class="text-gray-500">${escapeHtml(item.location)}</span>`
              : '';
            const calType = (isFieldVisible('events', 'calendarType') && item._calendarType)
              ? `<span class="text-xs px-1 py-0.5 bg-gray-100/50 text-gray-400 rounded">${escapeHtml(item._calendarType)}</span> `
              : '';

            let eventLine = calType;
            if (isFieldVisible('events', 'title')) {
              eventLine += `<span class="text-gray-500">${escapeHtml(eventTitle)}</span>`;
            }
            if (isFieldVisible('events', 'dateTime')) {
              eventLine += ` on ${dateStr}`;
            }
            eventLine += locationStr;

            // Meet link
            if (isFieldVisible('events', 'meetLink') && item.meetLink) {
              eventLine += ` <a href="${escapeHtml(item.meetLink)}" target="_blank" class="text-blue-600/70 hover:underline text-sm">[Video Link]</a>`;
            }

            sections.push(eventLine);

            // Description
            if (isFieldVisible('events', 'description') && item.description && item.description.trim()) {
              sections.push(`<details class="ml-4 my-1"><summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-500">Event details</summary><pre class="mt-2 p-3 bg-white/50 rounded text-xs text-gray-500 whitespace-pre-wrap max-h-48 overflow-y-auto">${escapeHtml(item.description)}</pre></details>`);
            }

            // Attendees
            if (isFieldVisible('events', 'attendees') && item.attendees && item.attendees.length > 0) {
              const attendeeList = item.attendees.map(a => a.email || a.displayName || a).join(', ');
              sections.push(`<span class="text-xs text-gray-400 ml-4">Attendees: ${escapeHtml(attendeeList)}</span>`);
            }
          });
        }
      }

      // â”€â”€â”€ Notes â”€â”€â”€
      if (notes && notes.length > 0) {
        const sortLabel = notesSortOrder === 'asc' ? 'oldest first' : 'newest first';
        sections.push(`<br><span class="text-teal-600 font-semibold">Notes (${notes.length})</span> <span class="text-xs text-gray-400">(${sortLabel})</span>`);

        // Group notes by type
        const notesByType = {};
        notes.forEach(note => {
          const type = note.Type || 'General';
          if (!notesByType[type]) notesByType[type] = [];
          notesByType[type].push(note);
        });

        // Sort notes by date based on notesSortOrder
        const sortedNotes = [...notes].sort((a, b) => {
          const dateA = a.Date ? new Date(a.Date).getTime() : 0;
          const dateB = b.Date ? new Date(b.Date).getTime() : 0;
          return notesSortOrder === 'asc' ? dateA - dateB : dateB - dateA;
        });

        sortedNotes.forEach(note => {
          const activity = note.Activity || 'Note';
          const type = note.Type || '';
          const noteDate = note.Date;
          const description = note.Description || '';
          const contact = note.Contact || '';
          const createdBy = note.Created_By || '';
          const dueDate = note.Due_Date;
          const matter = note.Matter || note.matter || '';

          let noteLine = '';

          // Type badge
          if (isFieldVisible('notes', 'type') && type) {
            noteLine += `<span class="text-xs px-1.5 py-0.5 bg-teal-100/50 text-teal-600 rounded mr-1">${escapeHtml(type)}</span>`;
          }

          // Activity (title)
          if (isFieldVisible('notes', 'activity')) {
            noteLine += `<span class="text-gray-800">${escapeHtml(activity)}</span>`;
          }

          // Date
          if (isFieldVisible('notes', 'date') && noteDate) {
            noteLine += ` <span class="text-gray-500">(${formatDate(noteDate)})</span>`;
          }

          // Due date
          if (isFieldVisible('notes', 'dueDate') && dueDate) {
            noteLine += ` <span class="text-amber-600 text-sm">Due: ${formatDate(dueDate)}</span>`;
          }

          // Contact
          if (isFieldVisible('notes', 'contact') && contact) {
            noteLine += ` â€” Contact: <span class="text-gray-600">${escapeHtml(contact)}</span>`;
          }

          // Created by
          if (isFieldVisible('notes', 'createdBy') && createdBy) {
            noteLine += ` <span class="text-gray-400 text-xs">(by ${escapeHtml(createdBy)})</span>`;
          }

          // Matter
          if (isFieldVisible('notes', 'matter') && matter) {
            noteLine += ` <span class="text-gray-400 text-xs">[${escapeHtml(matter)}]</span>`;
          }

          sections.push(noteLine);

          // Description
          if (isFieldVisible('notes', 'description') && description && description.trim()) {
            sections.push(`<details class="ml-4 my-1"><summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-500">View description</summary><pre class="mt-2 p-3 bg-white/50 rounded text-xs text-gray-500 whitespace-pre-wrap max-h-48 overflow-y-auto">${escapeHtml(description)}</pre></details>`);
          }
        });
      }

      return sections;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderHeader(data) {
      const _meta = data._meta || {};
      // Count directly from the data (excluding client since there's always 1)
      const entityCounts = [
        { label: 'case', count: Array.isArray(data.cases) ? data.cases.length : 0 },
        { label: 'application', count: Array.isArray(data.applications) ? data.applications.length : 0 },
        { label: 'event', count: (Array.isArray(data.hearings) ? data.hearings.length : 0) + (Array.isArray(data.events) ? data.events.length : 0) },
        { label: 'note', count: Array.isArray(data.notes) ? data.notes.length : 0 }
      ];
      const countBadges = entityCounts
        .filter(({ count }) => count > 0)
        .map(({ label, count }) => {
          const displayLabel = count === 1 ? label : label + 's';
          return `<span class="px-2 py-1 sm:px-2.5 rounded-full text-xs font-medium bg-gray-200 text-gray-700">${count} ${displayLabel}</span>`;
        }).join('');

      // Mobile: abbreviated labels, Desktop: full labels
      const viewLabelsShort = { structured: 'List', brief: 'Brief', detailed: 'Full', timeline: 'Time' };
      const viewLabelsFull = { structured: 'Structured', brief: 'Brief', detailed: 'Detailed', timeline: 'Timeline' };

      const viewButtons = ['structured', 'brief', 'detailed', 'timeline'].map(view => {
        const active = currentView === view;
        return `<button onclick="switchView('${view}')" class="px-3 py-2 sm:px-3 sm:py-1.5 text-sm rounded transition-colors touch-manipulation ${active ? 'bg-blue-500 text-white' : 'text-gray-500 hover:text-gray-800 hover:bg-gray-100/50'}">
          <span class="sm:hidden">${viewLabelsShort[view]}</span>
          <span class="hidden sm:inline">${viewLabelsFull[view]}</span>
        </button>`;
      }).join('');

      return `
        <div class="bg-white/50 rounded-lg p-4 border border-gray-200/50">
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
            <h1 class="text-lg font-semibold text-gray-900">Client Record</h1>
            <div class="flex items-center gap-2 sm:gap-3">
              <div class="flex gap-0.5 sm:gap-1 bg-gray-100/30 p-1 rounded-lg flex-1 sm:flex-none overflow-x-auto">${viewButtons}</div>
              <button onclick="openSettingsModal()" class="p-3 sm:p-2 text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors touch-manipulation flex-shrink-0" title="Field Settings">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-200/30">
            <p class="text-gray-400 text-xs">Last updated: ${formatDate(_meta.generatedAt) || 'Unknown'} <span id="refresh-countdown" class="text-gray-500 ml-1"></span></p>
            <div class="flex gap-1.5 sm:gap-2 flex-wrap justify-end">${countBadges}</div>
          </div>
        </div>
      `;
    }

    function renderNarrativeView(data, detailed = false) {
      const paragraphs = detailed ? generateDetailedNarrative(data) : generateBriefNarrative(data);

      const contentClass = detailed ? 'space-y-3' : 'space-y-2';

      return `
        <div class="max-w-6xl mx-auto space-y-4">
          ${renderHeader(data)}
          <div class="bg-white rounded-lg border border-gray-200/50 p-6">
            <div class="${contentClass} text-gray-700 leading-relaxed">
              ${paragraphs.map(p => `<p>${p}</p>`).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderFlatpackFields(flatpackData, title = 'Extracted Data') {
      if (!flatpackData || Object.keys(flatpackData).length === 0) return '';

      const fieldsHtml = Object.entries(flatpackData)
        .filter(([key, value]) => value !== null && value !== undefined && value !== '')
        .filter(([key]) => {
          // Hide fields containing 'flatpack' or 'merge history' by default
          const lowerKey = key.toLowerCase();
          const hasFlatpack = lowerKey.includes('flatpack');
          const hasMergeHistory = /merge[_.\s-]*history/i.test(lowerKey);
          return !hasFlatpack && !hasMergeHistory;
        })
        .map(([key, value]) => {
          // Format the key using centralized helper
          const formattedKey = formatFlatpackKey(key);

          // Format the value using centralized helper
          const formattedValue = formatFlatpackValue(value);

          return `
            <div>
              <p class="text-gray-400 text-xs uppercase tracking-wide">${escapeHtml(formattedKey)}</p>
              <p class="text-gray-800 text-sm">${escapeHtml(formattedValue)}</p>
            </div>
          `;
        })
        .join('');

      if (!fieldsHtml) return '';

      return `
        <div class="mt-4 pt-4 border-t border-gray-200/30">
          <p class="text-gray-500 text-xs uppercase tracking-wide mb-3 font-medium">${escapeHtml(title)}</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
            ${fieldsHtml}
          </div>
        </div>
      `;
    }

    function renderStructuredView(data) {
      const { client, cases, applications, hearings, events, notes } = data;

      // Build note index for contextual display
      const noteIndex = buildNoteIndex(notes, cases, applications, events);

      const casesByType = {};
      if (cases && cases.length > 0) {
        cases.forEach(c => {
          const type = c.Description || 'Other';
          if (!casesByType[type]) casesByType[type] = [];
          casesByType[type].push(c);
        });
      }

      let clientHtml = '';
      if (client) {
        const tags = (client['CM Tags'] || []).filter(Boolean).map(tag =>
          `<span class="px-2 py-1 bg-purple-500/20 text-purple-600 rounded text-xs">${escapeHtml(tag)}</span>`
        ).join('');

        const sijStatus = (client['SIJ Case Status'] && isFieldVisible('client', 'sijStatus'))
          ? `<div class="mt-4 pt-4 border-t border-gray-200/30">
              <p class="text-gray-400 text-xs uppercase tracking-wide mb-2">SIJ Status</p>
              <span class="inline-block px-2 py-1 bg-amber-500/20 text-amber-600 rounded text-sm">${escapeHtml(list(client['SIJ Case Status']))}</span>
            </div>`
          : '';

        const tagsSection = (tags && isFieldVisible('client', 'tags'))
          ? `<div class="mt-4 pt-4 border-t border-gray-200/30">
              <p class="text-gray-400 text-xs uppercase tracking-wide mb-2">Tags</p>
              <div class="flex flex-wrap gap-2">${tags}</div>
            </div>`
          : '';

        const address = client['Address Line 1']
          ? [client['Address Line 1'], client.City, client['State Formula'], client['Zip (5)']].filter(Boolean).join(', ')
          : 'â€”';

        // Build client fields grid based on visibility and order
        const clientFieldRenderers = {
          aNumber: () => `
            <div>
              <p class="text-gray-400 text-xs uppercase tracking-wide">A#</p>
              <p class="text-gray-800 font-mono text-sm">${escapeHtml(client['A#']) || 'â€”'}</p>
            </div>
          `,
          dob: () => `
            <div>
              <p class="text-gray-400 text-xs uppercase tracking-wide">DOB / Age</p>
              <p class="text-gray-800 text-sm">${formatDate(client.DOB) || 'â€”'}${getAge(client.DOB) ? ` (${getAge(client.DOB)}yo)` : ''}</p>
            </div>
          `,
          country: () => `
            <div>
              <p class="text-gray-400 text-xs uppercase tracking-wide">Country</p>
              <p class="text-gray-800 text-sm">${escapeHtml(client.Country) || 'â€”'}</p>
            </div>
          `,
          phone: () => `
            <div>
              <p class="text-gray-400 text-xs uppercase tracking-wide">Phone</p>
              <p class="text-gray-800 font-mono text-sm">${escapeHtml(formatPhone(client['Phone Number'])) || 'â€”'}</p>
            </div>
          `,
          address: () => `
            <div class="col-span-2">
              <p class="text-gray-400 text-xs uppercase tracking-wide">Address</p>
              <p class="text-gray-800 text-sm">${escapeHtml(address)}</p>
            </div>
          `
        };

        // Get ordered visible fields for client (excluding special sections like name, sijStatus, tags, flatpack)
        const gridFields = ['aNumber', 'dob', 'country', 'phone', 'address'];
        const orderedClientFields = getVisibleFields('client').filter(key => gridFields.includes(key));
        const clientFields = orderedClientFields.map(key => clientFieldRenderers[key]?.() || '').filter(Boolean);

        const clientName = isFieldVisible('client', 'name')
          ? escapeHtml(client['Client Name'] || client['Full_Name_Normal_Pretty'] || 'Unknown')
          : 'Client';

        const clientSoftrUrl = getSoftrClientUrl(getRecordId());
        clientHtml = `
          <div id="section-client" class="bg-white rounded-lg border border-gray-200/50 overflow-hidden transition-all">
            <button onclick="toggleSection('client')" class="w-full flex items-center justify-between p-4 hover:bg-gray-100/30 transition-colors touch-manipulation">
              <div class="flex items-center gap-3 min-w-0">
                <span class="w-10 h-10 sm:w-8 sm:h-8 rounded-full bg-emerald-500/20 text-emerald-600 flex items-center justify-center text-sm font-medium flex-shrink-0">C</span>
                <div class="text-left min-w-0">
                  <h2 class="font-medium text-gray-900">Client</h2>
                  <p class="text-gray-500 text-sm truncate">${clientName}</p>
                </div>
              </div>
              <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
                ${renderExternalLinkIcon(clientSoftrUrl, 'Open Client in Softr')}
                <span id="arrow-client" class="text-gray-400 transition-transform p-1" style="transform: rotate(180deg)">â–¼</span>
              </div>
            </button>
            <div id="content-client" class="px-4 pb-4 border-t border-gray-200/50">
              ${clientFields.length > 0 ? `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4 mt-4">${clientFields.join('')}</div>` : ''}
              ${sijStatus}
              ${tagsSection}
              ${(client._flatpack && isFieldVisible('client', 'flatpack')) ? renderFlatpackFields(client._flatpack, 'Matter Details (from Flatpack)') : ''}
              ${(client._bahr_flatpack && isFieldVisible('client', 'flatpack')) ? renderFlatpackFields(client._bahr_flatpack, 'Bahr Import Data') : ''}
            </div>
          </div>
        `;
      }

      let casesHtml = '';
      if (cases && cases.length > 0) {
        const caseTypesHtml = Object.entries(casesByType).map(([type, typeCases]) => {
          const caseItemsHtml = typeCases.map(c => {
            // Build case fields using ordered visibility
            const caseFieldRenderers = {
              court: () => c['Court/Office'] ? `<span class="text-gray-500">${escapeHtml(list(c['Court/Office']))}</span>` : null,
              judge: () => c['Judge text'] ? `<span class="text-gray-500">Judge ${escapeHtml(c['Judge text'])}</span>` : null,
              hearingDate: () => c['Hearing Date/Time'] ? `<span class="text-gray-500">${formatDate(val(c['Hearing Date/Time']))}</span>` : null,
              oyd: () => {
                const oyd = c['OYD '] || c['OYD'];
                return oyd ? `<span class="text-amber-600">OYD: ${formatDate(oyd)}</span>` : null;
              }
            };

            const orderedCaseFields = getVisibleFields('cases').filter(key => ['court', 'judge', 'hearingDate', 'oyd'].includes(key));
            const caseFields = orderedCaseFields.map(key => caseFieldRenderers[key]?.()).filter(Boolean);

            let daysBadge = '';
            const days = c['Days to Next Hearing'];
            if (isFieldVisible('cases', 'daysToHearing') && typeof days === 'number') {
              const urgency = getDaysUrgency(days);
              const bgClass = days <= 14 ? 'bg-red-500/30' : days <= 30 ? 'bg-red-500/20' : days <= 60 ? 'bg-amber-500/20' : 'bg-gray-100/50';
              daysBadge = `<span class="shrink-0 px-2 py-1 rounded text-xs ${bgClass} ${urgency.class}">${days}d</span>`;
            }

            let notesHtml = '';
            if (isFieldVisible('cases', 'notes') && c['Case Notes'] && c['Case Notes'].trim()) {
              notesHtml = `<details class="mt-2"><summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-500">View inline notes</summary><pre class="mt-2 p-2 bg-gray-50/50 rounded text-xs text-gray-500 whitespace-pre-wrap max-h-40 overflow-y-auto">${escapeHtml(c['Case Notes'])}</pre></details>`;
            }

            // Contextual notes from note index (linked note records)
            const caseId = c.id || c['Case Master View Record ID'];
            const linkedNotes = caseId ? getNotesForEntity(noteIndex, 'case', caseId) : [];
            const contextualNotesHtml = linkedNotes.length > 0 ? renderContextualNoteCards(linkedNotes, 3) : '';

            // Flatpack fields for case (now controlled by visibility)
            let flatpackHtml = '';
            if (isFieldVisible('cases', 'flatpack') && c._flatpack && Object.keys(c._flatpack).length > 0) {
              const flatpackFields = Object.entries(c._flatpack)
                .filter(([key, value]) => value !== null && value !== undefined && value !== '')
                .filter(([key]) => {
                  const lowerKey = key.toLowerCase();
                  return !lowerKey.includes('flatpack') && !/merge[_.\s-]*history/i.test(lowerKey);
                })
                .map(([key, value]) => {
                  const formattedKey = formatFlatpackKey(key);
                  const formattedValue = formatFlatpackValue(value);
                  return `<span class="text-gray-500"><span class="text-gray-400">${escapeHtml(formattedKey)}:</span> ${escapeHtml(formattedValue)}</span>`;
                })
                .join(' Â· ');
              if (flatpackFields) {
                flatpackHtml = `<div class="mt-2 text-xs">${flatpackFields}</div>`;
              }
            }

            return `
              <div class="px-4 py-3 hover:bg-gray-100/10 transition-colors">
                <div class="flex items-start justify-between gap-4">
                  <div class="flex-1 min-w-0">
                    <div class="flex flex-wrap gap-x-3 gap-y-1 text-sm">
                      ${caseFields.join('')}
                    </div>
                    ${flatpackHtml}
                  </div>
                  ${daysBadge}
                </div>
                ${notesHtml}
                ${contextualNotesHtml}
              </div>
            `;
          }).join('');

          return `
            <div class="border-b border-gray-200/30 last:border-b-0">
              <div class="px-4 py-3 bg-gray-100/20">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-medium text-gray-800">${escapeHtml(type)}</h3>
                  <span class="text-xs text-gray-400">${typeCases.length}</span>
                </div>
              </div>
              <div class="divide-y divide-gray-200">${caseItemsHtml}</div>
            </div>
          `;
        }).join('');

        const mattersSoftrUrl = getSoftrClientUrl(getRecordId(), 'tab12');
        casesHtml = `
          <div id="section-cases" class="bg-white rounded-lg border border-gray-200/50 overflow-hidden transition-all">
            <button onclick="toggleSection('cases')" class="w-full flex items-center justify-between p-4 hover:bg-gray-100/30 transition-colors touch-manipulation">
              <div class="flex items-center gap-3 min-w-0">
                <span class="w-10 h-10 sm:w-8 sm:h-8 rounded-full bg-blue-500/20 text-blue-600 flex items-center justify-center text-sm font-medium flex-shrink-0">${cases.length}</span>
                <div class="text-left min-w-0">
                  <h2 class="font-medium text-gray-900">Cases</h2>
                  <p class="text-gray-500 text-sm">${Object.keys(casesByType).length} ${pluralize(Object.keys(casesByType).length, 'type')}</p>
                </div>
              </div>
              <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
                ${renderExternalLinkIcon(mattersSoftrUrl, 'Open Matters in Softr')}
                <span id="arrow-cases" class="text-gray-400 transition-transform p-1" style="transform: rotate(180deg)">â–¼</span>
              </div>
            </button>
            <div id="content-cases" class="border-t border-gray-200/50">${caseTypesHtml}</div>
          </div>
        `;
      }

      // Specialized renderer for Applications
      // Store for application data to enable detail modals
      window._applicationItems = [];

      function renderApplicationsSection(items, noteIndex) {
        if (!items || items.length === 0) return '';

        // Store items for modal access
        window._applicationItems = items;

        const statusColors = {
          'Engaged': 'bg-green-500/20 text-green-400',
          'Potential': 'bg-amber-500/20 text-amber-600',
          'Filed': 'bg-blue-500/20 text-blue-600',
          'Pending': 'bg-amber-500/20 text-amber-600',
          'Approved': 'bg-emerald-500/20 text-emerald-600',
          'Denied': 'bg-red-500/20 text-red-600'
        };

        const itemsHtml = items.map((app, index) => {
          const status = app.Status;
          const statusClass = statusColors[status] || 'bg-gray-100/50 text-gray-500';
          const statusBadge = (isFieldVisible('applications', 'status') && status)
            ? `<span class="px-2 py-1 rounded text-xs ${statusClass}">${escapeHtml(status)}</span>`
            : '';

          const appType = isFieldVisible('applications', 'type') ? (app.Application || 'Application') : '';
          const name = isFieldVisible('applications', 'name') ? (app.Name || 'â€”') : '';
          const notes = app.Notes;

          let notesHtml = '';
          if (isFieldVisible('applications', 'notes') && notes && notes.trim()) {
            notesHtml = `<details class="mt-2"><summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-500">View inline notes</summary><pre class="mt-2 p-2 bg-gray-50/50 rounded text-xs text-gray-500 whitespace-pre-wrap max-h-40 overflow-y-auto">${escapeHtml(notes)}</pre></details>`;
          }

          // Contextual notes from note index (linked note records)
          const appId = app.id;
          const linkedNotes = appId && noteIndex ? getNotesForEntity(noteIndex, 'application', appId) : [];
          const contextualNotesHtml = linkedNotes.length > 0 ? renderContextualNoteCards(linkedNotes, 3) : '';

          // Build detail fields using ordered visibility
          const detailFieldRenderers = {
            receiptNumber: () => app['Receipt Number'] ? `<div><span class="text-gray-400">Receipt:</span> <span class="font-mono text-blue-600">${escapeHtml(app['Receipt Number'])}</span></div>` : null,
            certCounty: () => app['Cert County/State'] ? `<div><span class="text-gray-400">County/State:</span> <span class="text-gray-700">${escapeHtml(app['Cert County/State'])}</span></div>` : null,
            filedDate: () => app.createdTime ? `<div><span class="text-gray-400">Filed:</span> <span class="text-gray-700">${formatDate(app.createdTime)}</span></div>` : null
          };

          const orderedDetailFields = getVisibleFields('applications').filter(key => ['receiptNumber', 'certCounty', 'filedDate'].includes(key));
          const detailFields = orderedDetailFields.map(key => detailFieldRenderers[key]?.()).filter(Boolean);

          return `
            <div class="px-4 py-3 hover:bg-purple-50/50 border-b border-gray-200/20 last:border-b-0 cursor-pointer transition-colors group" onclick="showApplicationDetailModal(window._applicationItems[${index}])">
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    ${appType ? `<span class="text-purple-600 font-medium text-sm">${escapeHtml(appType)}</span>` : ''}
                    ${statusBadge}
                    <span class="text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity text-xs">Click for details</span>
                  </div>
                  ${name ? `<p class="text-gray-800 text-sm">${escapeHtml(name)}</p>` : ''}
                  ${detailFields.length > 0 ? `<div class="flex flex-wrap gap-x-4 gap-y-1 mt-2 text-xs">${detailFields.join('')}</div>` : ''}
                </div>
                <svg class="w-4 h-4 text-gray-300 group-hover:text-purple-400 transition-colors flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </div>
              ${notesHtml}
              ${contextualNotesHtml}
            </div>
          `;
        }).join('');

        const applicationsSoftrUrl = getSoftrClientUrl(getRecordId(), 'tab15');
        return `
          <div id="section-applications" class="bg-white rounded-lg border border-gray-200/50 overflow-hidden transition-all">
            <button onclick="toggleSection('applications')" class="w-full flex items-center justify-between p-4 hover:bg-gray-100/30 transition-colors touch-manipulation">
              <div class="flex items-center gap-3 min-w-0">
                <span class="w-10 h-10 sm:w-8 sm:h-8 rounded-full bg-purple-500/20 text-purple-600 flex items-center justify-center text-sm font-medium flex-shrink-0">${items.length}</span>
                <div class="text-left min-w-0">
                  <h2 class="font-medium text-gray-900">Applications</h2>
                  <p class="text-gray-500 text-sm">${items.length} ${pluralize(items.length, 'application')}</p>
                </div>
              </div>
              <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
                ${renderExternalLinkIcon(applicationsSoftrUrl, 'Open Applications in Softr')}
                <span id="arrow-applications" class="text-gray-400 transition-transform p-1" style="transform: rotate(180deg)">â–¼</span>
              </div>
            </button>
            <div id="content-applications" class="border-t border-gray-200/50">${itemsHtml}</div>
          </div>
        `;
      }

      // Specialized renderer for calendar events (events + hearings)
      // Store for event data to enable detail modals
      window._calendarEventItems = [];

      function renderCalendarSection(title, items, sectionId, iconBg, iconColor) {
        if (!items || items.length === 0) return '';

        // Store items for modal access
        window._calendarEventItems = items;

        const now = new Date();

        const itemsHtml = items.map((event, index) => {
          const eventTitle = event.title || event.summary || 'Event';
          const startDate = getEventStartDate(event);
          const endDate = getEventEndDate(event);
          const location = event.location;
          const description = event.description;
          const meetLink = event.meetLink;
          const attendees = event.attendees || [];
          const calType = event._calendarType;
          const isAllDay = event.isAllDay;
          const status = event.status;

          // Date display
          let dateDisplay = 'â€”';
          let isPast = false;
          if (startDate) {
            const startDateObj = new Date(startDate);
            isPast = startDateObj < now;
            if (isAllDay) {
              dateDisplay = formatDate(startDate);
            } else {
              const time = startDateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
              dateDisplay = `${formatDate(startDate)} at ${time}`;
            }
          }

          const pastClass = isPast ? 'opacity-60' : '';
          const calTypeBadge = (isFieldVisible('events', 'calendarType') && calType)
            ? `<span class="px-1.5 py-0.5 bg-gray-100/50 text-gray-500 rounded text-xs">${escapeHtml(calType)}</span>`
            : '';

          let descHtml = '';
          if (isFieldVisible('events', 'description') && description && description.trim()) {
            descHtml = `<details class="mt-2"><summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-500">View details</summary><pre class="mt-2 p-2 bg-gray-50/50 rounded text-xs text-gray-500 whitespace-pre-wrap max-h-40 overflow-y-auto">${escapeHtml(description)}</pre></details>`;
          }

          let attendeesHtml = '';
          if (isFieldVisible('events', 'attendees') && attendees.length > 0) {
            const attendeeList = attendees.map(a => a.email || a.displayName || a).join(', ');
            attendeesHtml = `<div class="text-xs text-gray-400 mt-1">Attendees: ${escapeHtml(attendeeList)}</div>`;
          }

          // Build detail fields using ordered visibility
          const eventDetailRenderers = {
            dateTime: () => `<div><span class="text-gray-400">When:</span> <span class="text-amber-600">${dateDisplay}</span></div>`,
            location: () => location ? `<div><span class="text-gray-400">Where:</span> <span class="text-gray-700">${escapeHtml(location)}</span></div>` : null,
            meetLink: () => meetLink ? `<div><a href="${escapeHtml(meetLink)}" target="_blank" class="text-blue-600 hover:underline">Video Link</a></div>` : null
          };

          const orderedEventFields = getVisibleFields('events').filter(key => ['dateTime', 'location', 'meetLink'].includes(key));
          const detailFields = orderedEventFields.map(key => eventDetailRenderers[key]?.()).filter(Boolean);
          // Add Google Calendar link for all events
          const calendarUrl = getGoogleCalendarEventUrl(event);
          detailFields.push(`<div>${renderCalendarLinkIcon(calendarUrl, 'Open in Google Calendar')}</div>`);

          const titleHtml = isFieldVisible('events', 'title')
            ? `<span class="text-gray-800 font-medium text-sm">${escapeHtml(eventTitle)}</span>`
            : '';

          return `
            <div class="px-4 py-3 hover:bg-amber-50/50 border-b border-gray-200/20 last:border-b-0 cursor-pointer transition-colors group ${pastClass}" onclick="showEventDetailModal(window._calendarEventItems[${index}])">
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    ${titleHtml}
                    ${calTypeBadge}
                    ${isPast ? '<span class="text-xs text-gray-400">(past)</span>' : ''}
                    <span class="text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity text-xs">Click for details</span>
                  </div>
                  ${detailFields.length > 0 ? `<div class="flex flex-wrap gap-x-4 gap-y-1 text-xs">${detailFields.join('')}</div>` : ''}
                  ${attendeesHtml}
                </div>
                <svg class="w-4 h-4 text-gray-300 group-hover:text-amber-400 transition-colors flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </div>
              ${descHtml}
            </div>
          `;
        }).join('');

        return `
          <div id="section-${sectionId}" class="bg-white rounded-lg border border-gray-200/50 overflow-hidden transition-all">
            <button onclick="toggleSection('${sectionId}')" class="w-full flex items-center justify-between p-4 hover:bg-gray-100/30 transition-colors touch-manipulation">
              <div class="flex items-center gap-3 min-w-0">
                <span class="w-10 h-10 sm:w-8 sm:h-8 rounded-full ${iconBg} ${iconColor} flex items-center justify-center text-sm font-medium flex-shrink-0">${items.length}</span>
                <div class="text-left min-w-0">
                  <h2 class="font-medium text-gray-900">${escapeHtml(title)}</h2>
                  <p class="text-gray-500 text-sm">${items.length} ${pluralize(items.length, 'event')}</p>
                </div>
              </div>
              <span id="arrow-${sectionId}" class="text-gray-400 transition-transform p-1 flex-shrink-0" style="transform: rotate(180deg)">â–¼</span>
            </button>
            <div id="content-${sectionId}" class="border-t border-gray-200/50">${itemsHtml}</div>
          </div>
        `;
      }

      const applicationsHtml = renderApplicationsSection(applications, noteIndex);
      // Combine hearings and events into a single Events section
      const allCalendarEvents = [...(hearings || []), ...(events || [])];
      const eventsHtml = renderCalendarSection('Events', allCalendarEvents, 'events', 'bg-amber-500/20', 'text-amber-600');

      // Notes section renderer
      function renderNotesSection(items) {
        const safeItems = items || [];
        const isEmpty = safeItems.length === 0;

        // Sort notes by date based on notesSortOrder
        const sortedItems = [...safeItems].sort((a, b) => {
          const dateA = a.Date ? new Date(a.Date).getTime() : 0;
          const dateB = b.Date ? new Date(b.Date).getTime() : 0;
          return notesSortOrder === 'asc' ? dateA - dateB : dateB - dateA;
        });

        // Group notes by type if available
        const notesByType = {};
        sortedItems.forEach(note => {
          const type = note.Type || 'General';
          if (!notesByType[type]) notesByType[type] = [];
          notesByType[type].push(note);
        });

        const typeColors = {
          'Call': 'bg-blue-500/20 text-blue-600',
          'Email': 'bg-green-500/20 text-green-600',
          'Meeting': 'bg-purple-500/20 text-purple-600',
          'Task': 'bg-amber-500/20 text-amber-600',
          'Note': 'bg-gray-500/20 text-gray-600',
          'General': 'bg-gray-500/20 text-gray-600'
        };

        const itemsHtml = sortedItems.map(note => {
          // Extract all schema fields
          const id = note.id || '';
          const activity = note.Activity || '';
          const type = note.Type || '';
          const noteDate = note.Date;
          const description = note.Description || '';
          const contact = note.Contact || '';
          const clientPpId = note.Client_PP_ID || '';
          const matter = note.Matter || note.matter || '';
          const recordId = note.RecordId || '';
          const createdBy = note.Created_By || '';
          const softrLink = note.Softr_Link_to_clients || '';
          const updated = note.Updated || '';
          const modified = note.Modified || '';
          const dueDate = note.Due_Date;
          const lastUpdateBy = note.Last_Update_By || '';
          const unixTimestamp = note.unix_timestamp || '';
          const timeRaw = note.time_raw || '';
          const tags = note.tags || [];
          const ppNoteId = note.pp_note_id || '';
          const matterId = note.matter_id || '';
          const source = note.source || '';
          const clientAirtableId = note.client_airtable_id || '';
          const eventId = note.eventId || '';
          const typeClass = typeColors[type] || typeColors['General'];

          // Primary fields
          const activityHtml = isFieldVisible('notes', 'activity') && activity
            ? `<span class="text-gray-800 font-medium text-sm">${escapeHtml(activity)}</span>`
            : '';

          const typeBadge = isFieldVisible('notes', 'type') && type
            ? `<span class="px-2 py-0.5 rounded text-xs ${typeClass}">${escapeHtml(type)}</span>`
            : '';

          const idHtml = isFieldVisible('notes', 'id') && id
            ? `<span class="text-gray-300 text-xs font-mono">#${escapeHtml(String(id))}</span>`
            : '';

          // Date fields
          const dateHtml = isFieldVisible('notes', 'date') && noteDate
            ? `<span class="text-gray-500 text-xs">${formatDate(noteDate)}</span>`
            : '';

          const dueDateHtml = isFieldVisible('notes', 'dueDate') && dueDate
            ? `<span class="text-amber-600 text-xs">Due: ${formatDate(dueDate)}</span>`
            : '';

          const updatedHtml = isFieldVisible('notes', 'updated') && updated
            ? `<span class="text-gray-400 text-xs">Updated: ${formatDate(updated)}</span>`
            : '';

          const modifiedHtml = isFieldVisible('notes', 'modified') && modified
            ? `<span class="text-gray-400 text-xs">Modified: ${formatDate(modified)}</span>`
            : '';

          // Entity reference fields
          const matterHtml = isFieldVisible('notes', 'matter') && matter
            ? `<span class="text-gray-400 text-xs">Matter: ${escapeHtml(matter)}</span>`
            : '';

          const matterIdHtml = isFieldVisible('notes', 'matterId') && matterId
            ? `<span class="text-gray-300 text-xs font-mono">Matter ID: ${escapeHtml(matterId)}</span>`
            : '';

          const eventIdHtml = isFieldVisible('notes', 'eventId') && eventId
            ? `<span class="text-gray-300 text-xs font-mono">Event ID: ${escapeHtml(eventId)}</span>`
            : '';

          const recordIdHtml = isFieldVisible('notes', 'recordId') && recordId
            ? `<span class="text-gray-300 text-xs font-mono">Record: ${escapeHtml(recordId)}</span>`
            : '';

          // Contact/Client fields
          const contactHtml = isFieldVisible('notes', 'contact') && contact
            ? `<span class="text-gray-500 text-xs">Contact: ${escapeHtml(contact)}</span>`
            : '';

          const clientPpIdHtml = isFieldVisible('notes', 'clientPpId') && clientPpId
            ? `<span class="text-gray-300 text-xs font-mono">Client PP: ${escapeHtml(clientPpId)}</span>`
            : '';

          const clientAirtableIdHtml = isFieldVisible('notes', 'clientAirtableId') && clientAirtableId
            ? `<span class="text-gray-300 text-xs font-mono">Airtable: ${escapeHtml(clientAirtableId)}</span>`
            : '';

          // Author fields
          const createdByHtml = isFieldVisible('notes', 'createdBy') && createdBy
            ? `<span class="text-gray-400 text-xs">By: ${escapeHtml(createdBy)}</span>`
            : '';

          const lastUpdateByHtml = isFieldVisible('notes', 'lastUpdateBy') && lastUpdateBy
            ? `<span class="text-gray-400 text-xs">Last update by: ${escapeHtml(lastUpdateBy)}</span>`
            : '';

          // Source & ID fields
          const sourceHtml = isFieldVisible('notes', 'source') && source
            ? `<span class="text-gray-400 text-xs italic">${escapeHtml(source)}</span>`
            : '';

          const ppNoteIdHtml = isFieldVisible('notes', 'ppNoteId') && ppNoteId
            ? `<span class="text-gray-300 text-xs font-mono">PP Note: ${escapeHtml(ppNoteId)}</span>`
            : '';

          // Link field
          const softrLinkHtml = isFieldVisible('notes', 'softrLink') && softrLink
            ? `<a href="${escapeHtml(softrLink)}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:text-blue-600 text-xs underline">View in Softr</a>`
            : '';

          // Technical fields (usually hidden)
          const unixTimestampHtml = isFieldVisible('notes', 'unixTimestamp') && unixTimestamp
            ? `<span class="text-gray-300 text-xs font-mono">Unix: ${escapeHtml(unixTimestamp)}</span>`
            : '';

          const timeRawHtml = isFieldVisible('notes', 'timeRaw') && timeRaw
            ? `<span class="text-gray-300 text-xs font-mono">Raw: ${escapeHtml(timeRaw)}</span>`
            : '';

          // Tags
          const tagsHtml = isFieldVisible('notes', 'tags') && tags.length > 0
            ? `<div class="flex flex-wrap gap-1 mt-1">${tags.map(tag =>
                `<span class="px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded text-xs">${escapeHtml(tag)}</span>`
              ).join('')}</div>`
            : '';

          // Description - show first 3 lines with "Read more" for longer content
          let descHtml = '';
          if (isFieldVisible('notes', 'description') && description && description.trim()) {
            const lines = description.split('\n');
            const previewLines = lines.slice(0, 3).join('\n');
            const hasMore = lines.length > 3;

            if (hasMore) {
              descHtml = `
                <div class="mt-2 p-2 bg-gray-50/50 rounded text-xs text-gray-500">
                  <pre class="whitespace-pre-wrap">${escapeHtml(previewLines)}</pre>
                  <details class="mt-1">
                    <summary class="text-xs text-blue-500 cursor-pointer hover:text-blue-600 font-medium">Read more</summary>
                    <pre class="mt-2 whitespace-pre-wrap max-h-40 overflow-y-auto">${escapeHtml(lines.slice(3).join('\n'))}</pre>
                  </details>
                </div>`;
            } else {
              descHtml = `<div class="mt-2 p-2 bg-gray-50/50 rounded text-xs text-gray-500"><pre class="whitespace-pre-wrap">${escapeHtml(description)}</pre></div>`;
            }
          }

          // Build metadata lines - grouped logically
          const primaryMetadata = [dateHtml, dueDateHtml, matterHtml, contactHtml, createdByHtml, sourceHtml].filter(Boolean);
          const secondaryMetadata = [updatedHtml, modifiedHtml, lastUpdateByHtml, softrLinkHtml].filter(Boolean);
          const idMetadata = [idHtml, recordIdHtml, matterIdHtml, eventIdHtml, ppNoteIdHtml, clientPpIdHtml, clientAirtableIdHtml].filter(Boolean);
          const technicalMetadata = [unixTimestampHtml, timeRawHtml].filter(Boolean);

          return `
            <div class="px-4 py-3 hover:bg-gray-100/10 border-b border-gray-200/20 last:border-b-0">
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1 flex-wrap">
                    ${activityHtml}
                    ${typeBadge}
                  </div>
                  ${primaryMetadata.length > 0 ? `<div class="flex flex-wrap gap-x-3 gap-y-1 text-xs">${primaryMetadata.join('')}</div>` : ''}
                  ${secondaryMetadata.length > 0 ? `<div class="flex flex-wrap gap-x-3 gap-y-1 text-xs mt-1">${secondaryMetadata.join('')}</div>` : ''}
                  ${idMetadata.length > 0 ? `<div class="flex flex-wrap gap-x-3 gap-y-1 text-xs mt-1">${idMetadata.join('')}</div>` : ''}
                  ${technicalMetadata.length > 0 ? `<div class="flex flex-wrap gap-x-3 gap-y-1 text-xs mt-1">${technicalMetadata.join('')}</div>` : ''}
                  ${tagsHtml}
                </div>
              </div>
              ${descHtml}
            </div>
          `;
        }).join('');

        const notesSoftrUrl = getSoftrClientUrl(getRecordId(), 'tab-notes');
        const emptyStateHtml = `
          <div class="px-4 py-8 text-center">
            <div class="text-gray-400 text-sm">No case notes recorded</div>
          </div>
        `;

        // Sort toggle button
        const sortLabel = notesSortOrder === 'asc' ? 'Oldest first' : 'Newest first';
        const sortIcon = notesSortOrder === 'asc'
          ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"/>'
          : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h9m5-4v12m0 0l-4-4m4 4l4-4"/>';

        return `
          <div id="section-notes" class="bg-white rounded-lg border border-gray-200/50 overflow-hidden transition-all">
            <div class="flex items-center justify-between p-4 border-b border-gray-200/30">
              <button onclick="toggleSection('notes')" class="flex items-center gap-3 min-w-0 hover:bg-gray-100/30 transition-colors touch-manipulation rounded-lg -m-2 p-2">
                <span class="w-10 h-10 sm:w-8 sm:h-8 rounded-full bg-teal-500/20 text-teal-600 flex items-center justify-center text-sm font-medium flex-shrink-0">${safeItems.length}</span>
                <div class="text-left min-w-0">
                  <h2 class="font-medium text-gray-900">Notes</h2>
                  <p class="text-gray-500 text-sm">${safeItems.length} ${pluralize(safeItems.length, 'note')}</p>
                </div>
                <span id="arrow-notes" class="text-gray-400 transition-transform p-1" style="transform: rotate(180deg)">â–¼</span>
              </button>
              <div class="flex items-center gap-2 flex-shrink-0">
                <button type="button" onclick="toggleNotesSortOrder(); return false;" class="flex items-center gap-1.5 px-2.5 py-1.5 text-xs text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-md transition-colors" title="Toggle sort order">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">${sortIcon}</svg>
                  <span class="hidden sm:inline">${sortLabel}</span>
                </button>
                ${renderExternalLinkIcon(notesSoftrUrl, 'Open Notes in Softr')}
              </div>
            </div>
            <div id="content-notes" class="border-t border-gray-200/50">${isEmpty ? emptyStateHtml : itemsHtml}</div>
          </div>
        `;
      }

      const notesHtml = renderNotesSection(notes);

      // Build the two-column layout for xl screens
      const hasLeftColumn = casesHtml || applicationsHtml;
      const hasRightColumn = eventsHtml;
      const hasBothColumns = hasLeftColumn && hasRightColumn;

      let mainContent = '';
      if (hasBothColumns) {
        // Two-column layout on xl screens
        mainContent = `
          <div class="xl:grid xl:grid-cols-2 xl:gap-4 space-y-4 xl:space-y-0">
            <div class="space-y-4">
              ${casesHtml}
              ${applicationsHtml}
            </div>
            <div class="space-y-4">
              ${eventsHtml}
            </div>
          </div>
        `;
      } else {
        // Single column fallback when one side is empty
        mainContent = `
          <div class="space-y-4">
            ${casesHtml}
            ${applicationsHtml}
            ${eventsHtml}
          </div>
        `;
      }

      return `
        <div class="max-w-6xl mx-auto space-y-4">
          ${renderHeader(data)}
          ${clientHtml}
          ${mainContent}
          ${notesHtml}
        </div>
      `;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TIMELINE VIEW - Chronological display of all dated events
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function extractTimelineEvents(data) {
      const { client, cases, applications, hearings, events, notes } = data;
      const timelineItems = [];
      const now = new Date();
      const multipleCases = cases && cases.length > 1;
      const clientName = client ? (client['Client Name'] || client['Full_Name_Normal_Pretty'] || 'Client').split(',')[0].trim() : 'Client';

      // Helper to check if a value is a valid date
      function isValidDate(val) {
        if (!val) return false;
        if (typeof val === 'object' && val.error) return false;
        if (typeof val === 'object' && val.specialValue) return false;
        const d = new Date(val);
        return !isNaN(d.getTime());
      }

      // Helper to get case identifier when there are multiple cases
      function getCaseLabel(c, idx) {
        if (c.Description) return c.Description;
        if (c['SIJ County']) return `SIJ (${c['SIJ County']})`;
        const court = val(c['Court/Office']);
        if (court) return court;
        return `Case ${idx + 1}`;
      }

      // â”€â”€â”€ CLIENT DATES â”€â”€â”€
      if (client) {
        const clientRecordId = client.id || client.recordId;

        if (isValidDate(client.DOB)) {
          timelineItems.push({
            date: new Date(client.DOB),
            statement: `${clientName} was born`,
            source: 'Client',
            recordName: clientName,
            recordId: clientRecordId,
            sectionId: 'client',
            icon: 'ğŸ‚',
            color: 'emerald'
          });
        }

        const entryDate = client['Entry Date'];
        if (isValidDate(entryDate)) {
          const placeOfEntry = client['Place of Entry'];
          timelineItems.push({
            date: new Date(entryDate),
            statement: placeOfEntry ? `Entered the U.S. at ${placeOfEntry}` : 'Entered the United States',
            source: 'Client',
            recordName: clientName,
            recordId: clientRecordId,
            sectionId: 'client',
            icon: 'ğŸ›¬',
            color: 'emerald'
          });
        }

        if (isValidDate(client.createdTime)) {
          timelineItems.push({
            date: new Date(client.createdTime),
            statement: 'Client file opened',
            source: 'Client',
            recordName: clientName,
            recordId: clientRecordId,
            sectionId: 'client',
            icon: 'ğŸ“',
            color: 'emerald'
          });
        }
      }

      // â”€â”€â”€ CASE DATES â”€â”€â”€
      if (cases && cases.length > 0) {
        cases.forEach((c, idx) => {
          const caseLabel = getCaseLabel(c, idx);
          const court = val(c['Court/Office']);
          const judge = c['Judge text'];
          const caseRecordId = c.id || c.recordId;

          const hearingDate = val(c['Hearing Date/Time']);
          if (isValidDate(hearingDate)) {
            let statement = multipleCases ? `${caseLabel} hearing` : 'Court hearing';
            if (court) statement += ` at ${court}`;

            timelineItems.push({
              date: new Date(hearingDate),
              statement: statement,
              detail: judge ? `Before Judge ${judge}` : null,
              source: 'Cases',
              recordName: caseLabel,
              recordId: caseRecordId,
              sectionId: 'cases',
              icon: 'âš–ï¸',
              color: 'amber'
            });
          }

          const oyd = c['OYD '] || c['OYD'];
          if (isValidDate(oyd)) {
            timelineItems.push({
              date: new Date(oyd),
              statement: multipleCases ? `${caseLabel}: One-year filing deadline` : 'One-year filing deadline',
              source: 'Cases',
              recordName: caseLabel,
              recordId: caseRecordId,
              sectionId: 'cases',
              icon: 'â°',
              color: 'amber'
            });
          }
        });
      }

      // â”€â”€â”€ APPLICATION DATES â”€â”€â”€
      if (applications && applications.length > 0) {
        applications.forEach(app => {
          const appType = app.Application || 'Application';
          const status = app.Status;
          const appRecordId = app.id || app.recordId;
          const appName = app.Name || appType;

          if (isValidDate(app.createdTime)) {
            let statement = `${appType} application filed`;
            if (status) statement += ` â€” ${status}`;

            timelineItems.push({
              date: new Date(app.createdTime),
              statement: statement,
              source: 'Applications',
              recordName: appName,
              recordId: appRecordId,
              sectionId: 'applications',
              icon: 'ğŸ“',
              color: 'purple'
            });
          }
        });
      }

      // â”€â”€â”€ CALENDAR EVENTS â”€â”€â”€
      const allCalendarEvents = [...(hearings || []), ...(events || [])];
      if (allCalendarEvents.length > 0) {
        allCalendarEvents.forEach(event => {
          const eventStartDate = getEventStartDate(event);
          if (isValidDate(eventStartDate)) {
            const eventTitle = event.title || event.summary || 'Event';
            const eventRecordId = event.id || event.eventId;

            timelineItems.push({
              date: new Date(eventStartDate),
              statement: eventTitle,
              detail: event.location || null,
              source: 'Events',
              recordName: eventTitle,
              recordId: eventRecordId,
              sectionId: 'events',
              meetLink: event.meetLink,
              calendarUrl: getGoogleCalendarEventUrl(event),
              icon: 'ğŸ“…',
              color: 'amber'
            });
          }
        });
      }

      // â”€â”€â”€ NOTES DATES â”€â”€â”€
      if (notes && notes.length > 0) {
        notes.forEach(note => {
          const noteDate = note.Date;
          const dueDate = note.Due_Date;
          const activity = note.Activity || 'Note';
          const noteType = note.Type || '';
          const noteRecordId = note.id || note.RecordId || note.pp_note_id;

          // Add note date
          if (isValidDate(noteDate)) {
            let statement = activity;
            if (noteType) statement = `${noteType}: ${activity}`;

            timelineItems.push({
              date: new Date(noteDate),
              statement: statement,
              detail: note.Contact ? `Contact: ${note.Contact}` : null,
              source: 'Notes',
              recordName: activity,
              recordId: noteRecordId,
              sectionId: 'notes',
              icon: 'ğŸ“‹',
              color: 'teal'
            });
          }

          // Add due date if present and different from note date
          if (isValidDate(dueDate)) {
            const dueDateObj = new Date(dueDate);
            const noteDateObj = noteDate ? new Date(noteDate) : null;
            // Only add due date if it's different from the note date
            if (!noteDateObj || dueDateObj.getTime() !== noteDateObj.getTime()) {
              timelineItems.push({
                date: dueDateObj,
                statement: `Due: ${activity}`,
                detail: noteType || null,
                source: 'Notes',
                recordName: activity,
                recordId: noteRecordId,
                sectionId: 'notes',
                icon: 'â°',
                color: 'teal'
              });
            }
          }
        });
      }

      timelineItems.sort((a, b) => a.date - b.date);
      return timelineItems;
    }

    function renderTimelineView(data) {
      const timelineItems = extractTimelineEvents(data);
      const now = new Date();

      if (timelineItems.length === 0) {
        return `
          <div class="max-w-6xl mx-auto space-y-4">
            ${renderHeader(data)}
            <div class="bg-white rounded-lg border border-gray-200/50 p-8 text-center">
              <p class="text-gray-500">No dated events found in the record.</p>
            </div>
          </div>
        `;
      }

      const past = timelineItems.filter(item => item.date < now);
      const future = timelineItems.filter(item => item.date >= now);

      const colorMap = {
        emerald: { bg: 'bg-emerald-500/20', text: 'text-emerald-600', border: 'border-emerald-500/40' },
        blue: { bg: 'bg-blue-500/20', text: 'text-blue-600', border: 'border-blue-500/40' },
        purple: { bg: 'bg-purple-500/20', text: 'text-purple-600', border: 'border-purple-500/40' },
        amber: { bg: 'bg-amber-500/20', text: 'text-amber-600', border: 'border-amber-500/40' },
        red: { bg: 'bg-red-500/20', text: 'text-red-600', border: 'border-red-500/40' },
        rose: { bg: 'bg-rose-500/20', text: 'text-rose-400', border: 'border-rose-500/40' },
        slate: { bg: 'bg-gray-100/20', text: 'text-gray-500', border: 'border-gray-300/40' }
      };

      function renderTimelineItem(item, isPast) {
        // Past items always use slate/grey
        const colors = isPast ? colorMap.slate : (colorMap[item.color] || colorMap.slate);
        const dateStr = item.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const hasTime = item.date.getHours() !== 0 || item.date.getMinutes() !== 0;
        const timeStr = hasTime ? item.date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : null;

        let detailLine = '';
        if (item.detail) {
          detailLine = `<p class="text-gray-400 text-sm mt-1">${escapeHtml(item.detail)}</p>`;
        }

        let meetLinkLine = '';
        if (item.meetLink && !isPast) {
          meetLinkLine = `<a href="${escapeHtml(item.meetLink)}" target="_blank" class="text-blue-600 hover:underline text-xs">Join Video</a>`;
        }

        // Add Google Calendar link for Events source
        let calendarLinkLine = '';
        if (item.source === 'Events' && item.calendarUrl) {
          calendarLinkLine = renderCalendarLinkIcon(item.calendarUrl, 'Open in Google Calendar');
        }

        // Record link - navigate to structured view and scroll to section
        const sourceColors = {
          'Client': 'bg-emerald-500/20 text-emerald-600 hover:bg-emerald-500/30',
          'Cases': 'bg-amber-500/20 text-amber-600 hover:bg-amber-500/30',
          'Applications': 'bg-purple-500/20 text-purple-600 hover:bg-purple-500/30',
          'Events': 'bg-amber-500/20 text-amber-600 hover:bg-amber-500/30'
        };
        const sourceColor = isPast ? 'bg-gray-100/40 text-gray-400 hover:bg-gray-100/60' : (sourceColors[item.source] || 'bg-gray-100/40 text-gray-500');

        const recordLink = item.sectionId
          ? `<button onclick="navigateToRecord('${item.sectionId}')" class="px-1.5 py-0.5 rounded text-[10px] font-medium ${sourceColor} transition-colors" title="View in ${item.source}">${escapeHtml(item.recordName || item.source)}</button>`
          : `<span class="px-1.5 py-0.5 rounded text-[10px] font-medium bg-gray-100/40 text-gray-400">${item.source}</span>`;

        return `
          <div class="flex gap-3 items-start">
            <div class="flex-shrink-0 w-11 h-11 sm:w-10 sm:h-10 rounded-xl ${colors.bg} ${colors.border} border flex items-center justify-center">
              <span class="text-lg ${isPast ? 'opacity-50' : ''}">${item.icon}</span>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-start sm:items-center gap-2 flex-wrap">
                <p class="${colors.text} font-medium text-base sm:text-sm break-words">${escapeHtml(item.statement)}</p>
                ${recordLink}
              </div>
              ${detailLine}
              <div class="flex items-center gap-2 sm:gap-3 mt-2 sm:mt-1 flex-wrap">
                <span class="text-gray-400 text-sm">${dateStr}${timeStr ? ` at ${timeStr}` : ''}</span>
                ${meetLinkLine}
                ${calendarLinkLine}
              </div>
            </div>
          </div>
        `;
      }

      let pastHtml = '';
      if (past.length > 0) {
        // Show most recent past events first
        const pastReversed = [...past].reverse();
        const pastItems = pastReversed.map(item => renderTimelineItem(item, true)).join('</div><div class="py-3 border-t border-gray-200/30">');
        pastHtml = `
          <div class="bg-white rounded-lg border border-gray-200/50 overflow-hidden">
            <button onclick="toggleSection('timeline-past')" class="w-full flex items-center justify-between p-4 hover:bg-gray-100/30 transition-colors touch-manipulation">
              <div class="flex items-center gap-3 min-w-0">
                <span class="w-10 h-10 sm:w-8 sm:h-8 rounded-full bg-gray-200/30 text-gray-500 flex items-center justify-center text-sm flex-shrink-0">${past.length}</span>
                <div class="text-left min-w-0">
                  <h2 class="font-medium text-gray-900">History</h2>
                  <p class="text-gray-400 text-sm">${past.length} past ${pluralize(past.length, 'event')}</p>
                </div>
              </div>
              <span id="arrow-timeline-past" class="text-gray-400 transition-transform p-1 flex-shrink-0" style="transform: rotate(180deg)">â–¼</span>
            </button>
            <div id="content-timeline-past" class="px-4 pb-4 border-t border-gray-200/50">
              <div class="py-3">${pastItems}</div>
            </div>
          </div>
        `;
      }

      let futureHtml = '';
      if (future.length > 0) {
        const futureItems = future.map(item => renderTimelineItem(item, false)).join('</div><div class="py-3 border-t border-gray-200/30">');
        futureHtml = `
          <div class="bg-white rounded-lg border border-gray-200/50 overflow-hidden">
            <button onclick="toggleSection('timeline-future')" class="w-full flex items-center justify-between p-4 hover:bg-gray-100/30 transition-colors touch-manipulation">
              <div class="flex items-center gap-3 min-w-0">
                <span class="w-10 h-10 sm:w-8 sm:h-8 rounded-full bg-amber-500/20 text-amber-600 flex items-center justify-center text-sm flex-shrink-0">${future.length}</span>
                <div class="text-left min-w-0">
                  <h2 class="font-medium text-gray-900">Upcoming</h2>
                  <p class="text-gray-400 text-sm">${future.length} scheduled ${pluralize(future.length, 'event')}</p>
                </div>
              </div>
              <span id="arrow-timeline-future" class="text-gray-400 transition-transform p-1 flex-shrink-0" style="transform: rotate(180deg)">â–¼</span>
            </button>
            <div id="content-timeline-future" class="px-4 pb-4 border-t border-gray-200/50">
              <div class="py-3">${futureItems}</div>
            </div>
          </div>
        `;
      }

      const nowIndicator = `
        <div class="flex items-center gap-3 py-1">
          <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
          <div class="flex-1 h-px bg-gradient-to-r from-green-500/40 to-transparent"></div>
          <span class="text-green-400 text-xs font-medium">Today</span>
          <div class="flex-1 h-px bg-gradient-to-l from-green-500/40 to-transparent"></div>
        </div>
      `;

      return `
        <div class="max-w-6xl mx-auto space-y-4">
          ${renderHeader(data)}
          ${futureHtml}
          ${past.length > 0 && future.length > 0 ? nowIndicator : ''}
          ${pastHtml}
        </div>
      `;
    }

    // Navigate from timeline to structured view and scroll to section
    function navigateToRecord(sectionId) {
      // Switch to structured view
      currentView = 'structured';
      if (window.currentData) {
        renderData(window.currentData);
      }

      // Update active view button
      document.querySelectorAll('[data-view]').forEach(btn => {
        btn.classList.remove('bg-gray-100', 'text-gray-900');
        btn.classList.add('text-gray-500');
      });
      const activeBtn = document.querySelector(`[data-view="structured"]`);
      if (activeBtn) {
        activeBtn.classList.add('bg-gray-100', 'text-gray-900');
        activeBtn.classList.remove('text-gray-500');
      }

      // Scroll to the section after a short delay to allow rendering
      setTimeout(() => {
        const section = document.getElementById(`section-${sectionId}`);
        if (section) {
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
          // Flash highlight effect
          section.classList.add('ring-2', 'ring-blue-500/50');
          setTimeout(() => section.classList.remove('ring-2', 'ring-blue-500/50'), 2000);
        }
      }, 100);
    }

    function renderData(data) {
      window.currentData = data;

      if (currentView === 'brief') {
        document.getElementById('app').innerHTML = renderNarrativeView(data, false);
      } else if (currentView === 'detailed') {
        document.getElementById('app').innerHTML = renderNarrativeView(data, true);
      } else if (currentView === 'timeline') {
        document.getElementById('app').innerHTML = renderTimelineView(data);
      } else {
        document.getElementById('app').innerHTML = renderStructuredView(data);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function init() {
      const recordId = getRecordId();

      if (!recordId) {
        renderError('Missing recordId parameter. Please provide a recordId in the URL (e.g., ?recordId=recXXX)');
        return;
      }

      try {
        // Fetch schema first to build dynamic field registry
        // This runs in parallel with data fetch for faster loading
        const schemaPromise = fetchSchemaAndBuildRegistry();

        const response = await fetch(`${DATA_URL}?recordId=${recordId}`);
        if (!response.ok) throw new Error(`Request failed (${response.status})`);
        const json = await response.json();

        if (!json || !json[0]) {
          throw new Error('No data returned for this record');
        }

        // Wait for schema to finish (if not already done)
        await schemaPromise;

        // Process flatpack JSON fields into individual fields
        const processedData = processDataWithFlatpack(json[0]);
        renderData(processedData);
      } catch (err) {
        renderError(err.message);
      }
    }

    // Auto-refresh countdown (5 minutes)
    const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes in ms
    let refreshTimeRemaining = REFRESH_INTERVAL;

    function startRefreshCountdown() {
      const updateCountdown = () => {
        refreshTimeRemaining -= 1000;
        const countdownEl = document.getElementById('refresh-countdown');
        if (countdownEl) {
          const minutes = Math.floor(refreshTimeRemaining / 60000);
          const seconds = Math.floor((refreshTimeRemaining % 60000) / 1000);
          countdownEl.textContent = `(refreshing in ${minutes}:${seconds.toString().padStart(2, '0')})`;
        }

        if (refreshTimeRemaining <= 0) {
          location.reload();
        }
      };

      // Update immediately, then every second
      updateCountdown();
      setInterval(updateCountdown, 1000);
    }

    init().then(() => {
      startRefreshCountdown();
    });
  </script>
</body>
</html>
