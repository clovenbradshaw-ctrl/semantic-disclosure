<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Record Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
  </style>
</head>
<body class="min-h-screen bg-slate-900 text-slate-100">
  <div id="app" class="p-4 md:p-6">
    <div class="max-w-4xl mx-auto">
      <div class="text-center py-12">
        <div class="w-8 h-8 border-2 border-blue-400 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
        <p class="text-slate-400 text-sm">Loading client data...</p>
      </div>
    </div>
  </div>

  <script>
    const DATA_URL = 'https://n8n.intelechia.com/webhook/c68fda2a-9302-4efb-930b-7063b85ef595';

    // View mode: 'structured' or 'narrative'
    let currentView = 'narrative';

    function getRecordId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('recordId') || 'recbMn886NM6d8eWf';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '‚Äî';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatDateLong(dateStr) {
      if (!dateStr) return null;
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    }

    function formatAge(dob) {
      if (!dob) return '‚Äî';
      const birth = new Date(dob);
      const now = new Date();
      let age = now.getFullYear() - birth.getFullYear();
      const m = now.getMonth() - birth.getMonth();
      if (m < 0 || (m === 0 && now.getDate() < birth.getDate())) age--;
      return `${age} years`;
    }

    function getAge(dob) {
      if (!dob) return null;
      const birth = new Date(dob);
      const now = new Date();
      let age = now.getFullYear() - birth.getFullYear();
      const m = now.getMonth() - birth.getMonth();
      if (m < 0 || (m === 0 && now.getDate() < birth.getDate())) age--;
      return age;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function toggleSection(sectionId) {
      const content = document.getElementById(`content-${sectionId}`);
      const arrow = document.getElementById(`arrow-${sectionId}`);
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
      } else {
        content.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
      }
    }

    function switchView(view) {
      currentView = view;
      if (window.currentData) {
        renderData(window.currentData);
      }
    }

    function renderError(message) {
      document.getElementById('app').innerHTML = `
        <div class="max-w-4xl mx-auto">
          <div class="bg-red-900/30 border border-red-500/50 rounded-lg p-6 max-w-md mx-auto mt-12">
            <p class="text-red-400 font-medium">Error loading data</p>
            <p class="text-red-300/70 text-sm mt-1">${escapeHtml(message)}</p>
          </div>
        </div>
      `;
    }

    // Generate semantic narrative from the data
    function generateNarrative(data) {
      const { client, cases } = data;
      const paragraphs = [];

      // Client introduction
      if (client) {
        const name = client['Client Name'] || client['Full_Name_Normal_Pretty'] || 'This client';
        const age = getAge(client.DOB);
        const country = client.Country;
        const aNumber = client['A#'];

        let intro = `<strong>${escapeHtml(name)}</strong>`;
        if (age && country) {
          intro += ` is a ${age}-year-old individual from ${escapeHtml(country)}`;
        } else if (age) {
          intro += ` is ${age} years old`;
        } else if (country) {
          intro += ` is from ${escapeHtml(country)}`;
        }
        if (aNumber) {
          intro += ` with A# <span class="font-mono text-blue-300">${escapeHtml(aNumber)}</span>`;
        }
        intro += '.';
        paragraphs.push(intro);

        // Contact information
        const phone = client['Phone Number'];
        const address = client['Address Line 1'];
        const city = client.City;
        const state = client['State Formula'];

        if (phone || address) {
          let contact = 'They can be reached';
          if (phone) {
            contact += ` at <span class="font-mono text-emerald-300">${escapeHtml(phone)}</span>`;
          }
          if (address && city) {
            contact += phone ? ' and' : '';
            contact += ` reside at ${escapeHtml(address)}, ${escapeHtml(city)}${state ? ', ' + escapeHtml(state) : ''}`;
          }
          contact += '.';
          paragraphs.push(contact);
        }

        // Tags and status
        const tags = (client['CM Tags'] || []).filter(Boolean);
        const sijStatus = client['SIJ Case Status'];

        if (sijStatus) {
          const statusText = Array.isArray(sijStatus) ? sijStatus.join(', ') : sijStatus;
          paragraphs.push(`Their SIJ case status is currently <span class="px-2 py-0.5 bg-amber-500/20 text-amber-300 rounded">${escapeHtml(statusText)}</span>.`);
        }

        if (tags.length > 0) {
          const tagSpans = tags.map(t => `<span class="px-2 py-0.5 bg-purple-500/20 text-purple-300 rounded text-sm">${escapeHtml(t)}</span>`).join(' ');
          paragraphs.push(`Case management tags: ${tagSpans}`);
        }
      }

      // Cases narrative
      if (cases && cases.length > 0) {
        // Group by type
        const casesByType = {};
        cases.forEach(c => {
          const type = c.Description || 'Other';
          if (!casesByType[type]) casesByType[type] = [];
          casesByType[type].push(c);
        });

        const typeCount = Object.keys(casesByType).length;
        paragraphs.push(`<br><strong>Case Summary:</strong> There ${cases.length === 1 ? 'is' : 'are'} <span class="text-blue-300 font-semibold">${cases.length} active case${cases.length !== 1 ? 's' : ''}</span> across ${typeCount} category${typeCount !== 1 ? 'ies' : 'y'}.`);

        // Narrative for each case type
        for (const [type, typeCases] of Object.entries(casesByType)) {
          let typeNarrative = `<br><span class="text-slate-300 font-medium">${escapeHtml(type)}</span> (${typeCases.length}): `;

          const caseDescriptions = typeCases.map(c => {
            const parts = [];
            const court = c['Court/Office'];
            const judge = c['Judge text'];
            const hearing = c['Hearing Date/Time'];
            const daysToHearing = c['Days to Next Hearing'];

            if (court) {
              const courtText = Array.isArray(court) ? court.join(', ') : court;
              parts.push(`at ${escapeHtml(courtText)}`);
            }
            if (judge) {
              parts.push(`before Judge ${escapeHtml(judge)}`);
            }
            if (hearing) {
              const hearingDate = formatDateLong(Array.isArray(hearing) ? hearing[0] : hearing);
              if (hearingDate) {
                let hearingText = `next hearing on <span class="text-emerald-300">${hearingDate}</span>`;
                if (typeof daysToHearing === 'number') {
                  const urgencyClass = daysToHearing <= 30 ? 'text-red-400 font-semibold' :
                                       daysToHearing <= 60 ? 'text-amber-400' : 'text-slate-400';
                  hearingText += ` <span class="${urgencyClass}">(${daysToHearing} days)</span>`;
                }
                parts.push(hearingText);
              }
            }

            return parts.length > 0 ? parts.join(', ') : 'details pending';
          });

          typeNarrative += caseDescriptions.join('; ') + '.';
          paragraphs.push(typeNarrative);

          // Add notes if present
          typeCases.forEach(c => {
            if (c['Case Notes'] && c['Case Notes'].trim()) {
              paragraphs.push(`<details class="ml-4 my-2"><summary class="text-xs text-slate-500 cursor-pointer hover:text-slate-400">Notes for case ${escapeHtml(c._recordId)}</summary><pre class="mt-2 p-3 bg-slate-800/50 rounded text-xs text-slate-400 whitespace-pre-wrap">${escapeHtml(c['Case Notes'])}</pre></details>`);
            }
          });
        }

        // Urgency summary
        const urgentCases = cases.filter(c => typeof c['Days to Next Hearing'] === 'number' && c['Days to Next Hearing'] <= 30);
        const soonCases = cases.filter(c => typeof c['Days to Next Hearing'] === 'number' && c['Days to Next Hearing'] > 30 && c['Days to Next Hearing'] <= 60);

        if (urgentCases.length > 0 || soonCases.length > 0) {
          let urgencyNote = '<br><strong>Timeline Alerts:</strong> ';
          if (urgentCases.length > 0) {
            urgencyNote += `<span class="text-red-400">${urgentCases.length} case${urgentCases.length !== 1 ? 's' : ''} require${urgentCases.length === 1 ? 's' : ''} immediate attention (hearing within 30 days)</span>`;
          }
          if (urgentCases.length > 0 && soonCases.length > 0) {
            urgencyNote += ' and ';
          }
          if (soonCases.length > 0) {
            urgencyNote += `<span class="text-amber-400">${soonCases.length} case${soonCases.length !== 1 ? 's have' : ' has'} hearings within 60 days</span>`;
          }
          urgencyNote += '.';
          paragraphs.push(urgencyNote);
        }
      } else {
        paragraphs.push('<br><span class="text-slate-500">No active cases on file.</span>');
      }

      return paragraphs;
    }

    function renderNarrativeView(data) {
      const { _meta } = data;
      const paragraphs = generateNarrative(data);

      return `
        <div class="max-w-4xl mx-auto space-y-4">
          ${renderHeader(_meta)}
          <div class="bg-slate-800 rounded-lg border border-slate-700/50 p-6">
            <div class="prose prose-invert max-w-none">
              <div class="space-y-3 text-slate-300 leading-relaxed">
                ${paragraphs.map(p => `<p>${p}</p>`).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderHeader(_meta) {
      const countBadges = Object.entries(_meta.recordCounts).map(([type, count]) => {
        const colorClass = count > 0 ? 'bg-blue-500/20 text-blue-300' : 'bg-slate-700/50 text-slate-500';
        return `<span class="px-2 py-1 rounded ${colorClass}">${type}: ${count}</span>`;
      }).join('');

      return `
        <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50">
          <div class="flex items-center justify-between flex-wrap gap-2">
            <h1 class="text-lg font-semibold text-slate-100">Client Record Viewer</h1>
            <div class="flex items-center gap-4">
              <div class="flex gap-1 bg-slate-700/50 p-1 rounded-lg">
                <button onclick="switchView('narrative')" class="px-3 py-1 text-sm rounded ${currentView === 'narrative' ? 'bg-blue-500 text-white' : 'text-slate-400 hover:text-slate-200'}">Narrative</button>
                <button onclick="switchView('structured')" class="px-3 py-1 text-sm rounded ${currentView === 'structured' ? 'bg-blue-500 text-white' : 'text-slate-400 hover:text-slate-200'}">Structured</button>
              </div>
              <div class="flex gap-3 text-xs">${countBadges}</div>
            </div>
          </div>
          <p class="text-slate-500 text-xs mt-2">Generated: ${formatDate(_meta.generatedAt)}</p>
        </div>
      `;
    }

    function renderStructuredView(data) {
      const { _meta, client, cases } = data;

      // Group cases by type
      const casesByType = {};
      if (cases && cases.length > 0) {
        cases.forEach(c => {
          const type = c.Description || 'Other';
          if (!casesByType[type]) casesByType[type] = [];
          casesByType[type].push(c);
        });
      }

      // Client section
      let clientHtml = '';
      if (client) {
        const tags = (client['CM Tags'] || []).filter(Boolean).map(tag =>
          `<span class="px-2 py-1 bg-purple-500/20 text-purple-300 rounded text-xs">${escapeHtml(tag)}</span>`
        ).join('');

        const sijStatus = client['SIJ Case Status']
          ? `<div class="mt-4 pt-4 border-t border-slate-700/30">
              <p class="text-slate-500 text-xs uppercase tracking-wide mb-2">SIJ Status</p>
              <span class="inline-block px-2 py-1 bg-amber-500/20 text-amber-300 rounded text-sm">
                ${escapeHtml(Array.isArray(client['SIJ Case Status']) ? client['SIJ Case Status'].join(', ') : client['SIJ Case Status'])}
              </span>
            </div>`
          : '';

        const tagsSection = tags
          ? `<div class="mt-4 pt-4 border-t border-slate-700/30">
              <p class="text-slate-500 text-xs uppercase tracking-wide mb-2">Tags</p>
              <div class="flex flex-wrap gap-2">${tags}</div>
            </div>`
          : '';

        const address = client['Address Line 1']
          ? `${client['Address Line 1']}, ${client.City || ''} ${client['State Formula'] || ''} ${client['Zip (5)'] || ''}`
          : '‚Äî';

        clientHtml = `
          <div class="bg-slate-800 rounded-lg border border-slate-700/50 overflow-hidden">
            <button onclick="toggleSection('client')" class="w-full flex items-center justify-between p-4 hover:bg-slate-700/30 transition-colors">
              <div class="flex items-center gap-3">
                <span class="w-8 h-8 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-sm">üë§</span>
                <div class="text-left">
                  <h2 class="font-medium text-slate-100">Client</h2>
                  <p class="text-slate-400 text-sm">${escapeHtml(client['Client Name'] || client['Full_Name_Normal_Pretty'])}</p>
                </div>
              </div>
              <span id="arrow-client" class="text-slate-500 transition-transform" style="transform: rotate(180deg)">‚ñº</span>
            </button>
            <div id="content-client" class="px-4 pb-4 border-t border-slate-700/50">
              <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">
                <div>
                  <p class="text-slate-500 text-xs uppercase tracking-wide">A#</p>
                  <p class="text-slate-200 font-mono text-sm">${escapeHtml(client['A#']) || '‚Äî'}</p>
                </div>
                <div>
                  <p class="text-slate-500 text-xs uppercase tracking-wide">DOB</p>
                  <p class="text-slate-200 text-sm">${formatDate(client.DOB)} (${formatAge(client.DOB)})</p>
                </div>
                <div>
                  <p class="text-slate-500 text-xs uppercase tracking-wide">Country</p>
                  <p class="text-slate-200 text-sm">${escapeHtml(client.Country) || '‚Äî'}</p>
                </div>
                <div>
                  <p class="text-slate-500 text-xs uppercase tracking-wide">Phone</p>
                  <p class="text-slate-200 font-mono text-sm">${escapeHtml(client['Phone Number']) || '‚Äî'}</p>
                </div>
                <div class="col-span-2">
                  <p class="text-slate-500 text-xs uppercase tracking-wide">Address</p>
                  <p class="text-slate-200 text-sm">${escapeHtml(address)}</p>
                </div>
              </div>
              ${sijStatus}
              ${tagsSection}
            </div>
          </div>
        `;
      }

      // Cases section
      let casesHtml = '';
      if (cases && cases.length > 0) {
        const caseTypesHtml = Object.entries(casesByType).map(([type, typeCases]) => {
          const caseItemsHtml = typeCases.map(caseItem => {
            const court = caseItem['Court/Office']
              ? `<span>üìç ${escapeHtml(Array.isArray(caseItem['Court/Office']) ? caseItem['Court/Office'].join(', ') : caseItem['Court/Office'])}</span>`
              : '';
            const judge = caseItem['Judge text']
              ? `<span>‚öñÔ∏è ${escapeHtml(caseItem['Judge text'])}</span>`
              : '';
            const hearing = caseItem['Hearing Date/Time']
              ? `<span>üìÖ ${formatDate(Array.isArray(caseItem['Hearing Date/Time']) ? caseItem['Hearing Date/Time'][0] : caseItem['Hearing Date/Time'])}</span>`
              : '';

            let daysBadge = '';
            if (caseItem['Days to Next Hearing'] && typeof caseItem['Days to Next Hearing'] === 'number') {
              const days = caseItem['Days to Next Hearing'];
              const colorClass = days <= 30 ? 'bg-red-500/20 text-red-300' :
                                 days <= 60 ? 'bg-amber-500/20 text-amber-300' :
                                 'bg-slate-700/50 text-slate-400';
              daysBadge = `<span class="shrink-0 px-2 py-1 rounded text-xs ${colorClass}">${days}d</span>`;
            }

            let notesHtml = '';
            if (caseItem['Case Notes'] && caseItem['Case Notes'].trim()) {
              notesHtml = `
                <details class="mt-2">
                  <summary class="text-xs text-slate-500 cursor-pointer hover:text-slate-400">View notes</summary>
                  <pre class="mt-2 p-2 bg-slate-900/50 rounded text-xs text-slate-400 overflow-x-auto whitespace-pre-wrap max-h-40 overflow-y-auto">${escapeHtml(caseItem['Case Notes'])}</pre>
                </details>
              `;
            }

            return `
              <div class="px-4 py-3 hover:bg-slate-700/10 transition-colors">
                <div class="flex items-start justify-between gap-4">
                  <div class="flex-1 min-w-0">
                    <p class="text-slate-300 text-sm font-mono truncate">${escapeHtml(caseItem._recordId)}</p>
                    <div class="flex flex-wrap gap-x-4 gap-y-1 mt-1 text-xs text-slate-500">
                      ${court}${judge}${hearing}
                    </div>
                  </div>
                  ${daysBadge}
                </div>
                ${notesHtml}
              </div>
            `;
          }).join('');

          return `
            <div class="border-b border-slate-700/30 last:border-b-0">
              <div class="px-4 py-3 bg-slate-700/20">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-medium text-slate-200">${escapeHtml(type)}</h3>
                  <span class="text-xs text-slate-500">${typeCases.length} case${typeCases.length !== 1 ? 's' : ''}</span>
                </div>
              </div>
              <div class="divide-y divide-slate-700/20">
                ${caseItemsHtml}
              </div>
            </div>
          `;
        }).join('');

        casesHtml = `
          <div class="bg-slate-800 rounded-lg border border-slate-700/50 overflow-hidden">
            <button onclick="toggleSection('cases')" class="w-full flex items-center justify-between p-4 hover:bg-slate-700/30 transition-colors">
              <div class="flex items-center gap-3">
                <span class="w-8 h-8 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center text-sm">üìÅ</span>
                <div class="text-left">
                  <h2 class="font-medium text-slate-100">Cases</h2>
                  <p class="text-slate-400 text-sm">${cases.length} total ¬∑ ${Object.keys(casesByType).length} types</p>
                </div>
              </div>
              <span id="arrow-cases" class="text-slate-500 transition-transform" style="transform: rotate(180deg)">‚ñº</span>
            </button>
            <div id="content-cases" class="border-t border-slate-700/50">
              ${caseTypesHtml}
            </div>
          </div>
        `;
      }

      // Empty sections notice
      const emptySections = Object.entries(_meta.recordCounts)
        .filter(([key, count]) => count === 0)
        .map(([key]) => key);

      const emptyNotice = emptySections.length > 0
        ? `<div class="bg-slate-800/30 rounded-lg p-4 border border-slate-700/30">
            <p class="text-slate-500 text-sm">
              <span class="text-slate-400">Empty sections:</span> ${emptySections.join(', ')}
            </p>
          </div>`
        : '';

      return `
        <div class="max-w-4xl mx-auto space-y-4">
          ${renderHeader(_meta)}
          ${clientHtml}
          ${casesHtml}
          ${emptyNotice}
        </div>
      `;
    }

    function renderData(data) {
      window.currentData = data;

      if (currentView === 'narrative') {
        document.getElementById('app').innerHTML = renderNarrativeView(data);
      } else {
        document.getElementById('app').innerHTML = renderStructuredView(data);
      }
    }

    // Fetch and render
    async function init() {
      try {
        const recordId = getRecordId();
        const response = await fetch(`${DATA_URL}?recordId=${recordId}`);
        if (!response.ok) throw new Error('Failed to fetch data');
        const json = await response.json();
        renderData(json[0]);
      } catch (err) {
        renderError(err.message);
      }
    }

    init();
  </script>
</body>
</html>
